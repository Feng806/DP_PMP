<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> <span class="keyword">...</span><span class="comment">            --- Ausgangsgrößen:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line">[   <span class="var type1" id="S2T111U3">batEngDltOptMat</span>,  <span class="keyword">...</span><span class="comment"> Vektor - optimale Batterieenergieänderung</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line">    <span class="var type1" id="S3T111U4">fulEngDltOptMat</span>,  <span class="keyword">...</span><span class="comment"> Vektor - optimale Kraftstoffenergieänderung</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line">    <span class="var type1" id="S4T111U5">geaStaMat</span>,        <span class="keyword">...</span><span class="comment"> Vektor - Trajektorie des optimalen Antriebsstrangzustands</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line">    <span class="var type1" id="S5T111U6">engStaMat</span>,        <span class="keyword">...</span><span class="comment"> vector showing optimal engine contorl w/ profile</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line">    <span class="var type1" id="S6T111U7">batPwrMat</span>,        <span class="keyword">...</span><span class="comment"> vector showing optimal battery level control</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line">    <span class="var type1" id="S7T111U8">batEngMat</span>,        <span class="keyword">...</span><span class="comment"> vector showing optimal battery levels</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line">    <span class="var type1" id="S8T111U9">fulEngOptVec</span>,     <span class="keyword">...</span><span class="comment"> Skalar - optimale Kraftstoffenergie</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line">    <span class="var type1" id="S9T111U10">resVld</span>            <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line">    ] =               <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line">    runFocusDP(       <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line">    <span class="var type1" id="S10T1U13">inputparams</span>,      <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line">    <span class="var type1" id="S11T3U14">tst_scalar_struct</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line">    <span class="var type1" id="S12T32U15">fzg_scalar_struct</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line">    <span class="var type1" id="S13T7U16">nedc_array_struct</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line">    <span class="var type1" id="S14T71U17">fzg_array_struct</span>  <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line">    )<span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"><span class="comment">%% assign structure fields to variables</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"><span class="comment">% inputparams - originally simulink inputs</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="var type0" id="S15T0U20">disFlg</span>          = <span class="var type1" id="S10T1U22">inputparams</span>.disFlg;</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"><span class="var type0" id="S16T0U26">iceFlgBool</span>      = <span class="var type1" id="S10T1U28">inputparams</span>.iceFlgBool;</span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="var type0" id="S17T0U32">brkBool</span>         = <span class="var type1" id="S10T1U34">inputparams</span>.brkBool;</span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="var type1" id="S18T2U38">iceExtBool</span>      = <span class="var type1" id="S10T1U40">inputparams</span>.iceExtBool;</span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line"><span class="var type1" id="S19T2U44">timStp</span>          = <span class="var type1" id="S10T1U46">inputparams</span>.timStp;</span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line"><span class="var type1" id="S20T2U50">batEngBegMinRat</span> = <span class="var type1" id="S10T1U52">inputparams</span>.batEngBegMinRat;</span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"><span class="var type1" id="S21T2U56">batEngBegMaxRat</span> = <span class="var type1" id="S10T1U58">inputparams</span>.batEngBegMaxRat;</span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"><span class="var type1" id="S22T2U62">batEngEndMinRat</span> = <span class="var type1" id="S10T1U64">inputparams</span>.batEngEndMinRat;</span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"><span class="var type1" id="S23T2U68">batEngEndMaxRat</span> = <span class="var type1" id="S10T1U70">inputparams</span>.batEngEndMaxRat;</span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"><span class="var type0" id="S24T0U74">batPwrAux</span>       = <span class="var type1" id="S10T1U76">inputparams</span>.batPwrAux;</span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"><span class="var type0" id="S25T0U80">engBeg</span>          = <span class="var type1" id="S10T1U82">inputparams</span>.engBeg;</span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"><span class="var type0" id="S26T0U86">engEnd</span>          = <span class="var type1" id="S10T1U88">inputparams</span>.engEnd;</span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"><span class="var type0" id="S27T0U92">staChgPenCosVal</span> = <span class="var type1" id="S10T1U94">inputparams</span>.staChgPenCosVal;</span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"><span class="var type0" id="S28T0U98">timInxBeg</span>       = <span class="var type1" id="S10T1U100">inputparams</span>.timInxBeg;</span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"><span class="var type0" id="S29T0U104">timInxEnd</span>       = <span class="var type1" id="S10T1U106">inputparams</span>.timInxEnd;</span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"><span class="var type0" id="S30T0U110">staBeg</span>          = <span class="var type1" id="S10T1U112">inputparams</span>.staBeg;</span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"><span class="comment">% get the max 100% battery energy value possible</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line"><span class="var type1" id="S31T2U116">batEngStp</span>       = <span class="var type1" id="S11T3U118">tst_scalar_struct</span>.batEngStp;</span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line"><span class="var type1" id="S32T2U122">batEngMax</span>       = <span class="var type1" id="S11T3U124">tst_scalar_struct</span>.batEngMax;</span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line"><span class="var type1" id="S33T2U128">batEngMin</span>       = <span class="var type1" id="S11T3U130">tst_scalar_struct</span>.batEngMin;</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"><span class="comment">% tst_scalar_struct - originally tstDat800 structure</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line"><span class="var type0" id="S34T0U134">geaStaNum</span>          = <span class="var type1" id="S11T3U136">tst_scalar_struct</span>.staNum;</span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line"><span class="var type0" id="S35T0U140">engStaNum</span>       = <span class="var type1" id="S11T3U142">tst_scalar_struct</span>.engStaNum;</span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"><span class="var type0" id="S36T0U146">batStaNum</span>       = (<span class="var type1" id="S32T2U151">batEngMax</span> - <span class="var type1" id="S33T2U152">batEngMin</span>) / <span class="var type1" id="S31T2U153">batEngStp</span> + 1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"><span class="comment">% nedc_array_struct - save vector values</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"><span class="var type1" id="S37T9U157">timVecRaw</span>  = <span class="var type1" id="S13T7U160">nedc_array_struct</span>.vehVel(:,1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"><span class="var type1" id="S38T9U166">velVecRaw</span>   = <span class="var type1" id="S13T7U169">nedc_array_struct</span>.vehVel(:,2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line"><span class="var type1" id="S39T9U175">slopeVecRaw</span> = <span class="var type1" id="S13T7U177">nedc_array_struct</span>.refSlpVec;</span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line"><span class="comment">% acceleration : dV/dt</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line"><span class="var type1" id="S40T9U181">accVecRaw</span>   = gradient(<span class="var type1" id="S38T9U184">velVecRaw</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line"><span class="comment">% discretize raw data wrt tim interval step size</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line"><span class="var type1" id="S42T22U187">timVec</span>     = <span class="var type1" id="S37T9U191">timVecRaw</span>(1) : <span class="var type1" id="S19T2U193">timStp</span> : <span class="var type1" id="S37T9U195">timVecRaw</span>(end);</span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line">[<span class="var type1" id="S44T29U201">timBool</span>, <span class="mxinfo " id="T9:U60">~</span>]= ismember(<span class="var type1" id="S37T9U205">timVecRaw</span>, <span class="var type1" id="S42T22U206">timVec</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line"><span class="var type1" id="S46T24U209">velVec</span>      = <span class="var type1" id="S38T9U211">velVecRaw</span>(<span class="var type1" id="S44T29U212">timBool</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line"><span class="comment">% preprocess velVec</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line"><span class="var type1" id="S46T24U216">velVec</span>(<span class="var type1" id="S46T24U218">velVec</span> &lt; <span class="var type1" id="S12T32U220">fzg_scalar_struct</span>.vehVelThresh) = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line"><span class="var type1" id="S47T24U225">accVec</span>      = <span class="var type1" id="S40T9U227">accVecRaw</span>(<span class="var type1" id="S44T29U228">timBool</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line"><span class="comment">% disVec      = velVec * timStp;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"><span class="var type1" id="S48T24U231">slopeVec</span>    = <span class="var type1" id="S39T9U233">slopeVecRaw</span>(<span class="var type1" id="S44T29U234">timBool</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"><span class="comment">% determine tim length of interval</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line"><span class="var type0" id="S49T0U237">timNum</span>     = length(<span class="var type1" id="S42T22U240">timVec</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line"><span class="comment">% PrÃ¼fen(check), ob eine erlaubte Beschleunigung vorliegt.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line"><span class="comment">% Ansonsten zum nÃ¤chsten Schleifendurchlauf springen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line"><span class="comment">%   Check whether an allowable acceleration exists - if not, warn user</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line"><span class="comment">% vehAcc = (engKinAct-engKinPre)/vehMas/wayStp;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line"><span class="keyword">if</span> any(<span class="var type1" id="S47T24U247">accVec</span> &lt; <span class="var type1" id="S12T32U249">fzg_scalar_struct</span>.vehAccMin) || any(<span class="var type1" id="S47T24U254">accVec</span> &gt; <span class="var type1" id="S12T32U256">fzg_scalar_struct</span>.vehAccMax)</span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line">    <span class="var type1" id="S52T46U260">overdemandAcc</span> = find(<span class="message error" id="M1F1C"><span class="var type1" id="S47T24U265">accVec</span>&lt;<span class="var type1" id="S12T32U267">fzg_scalar_struct</span>.vehAccMin</span> || <span class="message error" id="M2F1C"><span class="var type1" id="S47T24U270">accVec</span>&gt;<span class="var type1" id="S12T32U272">fzg_scalar_struct</span>.vehAccMax</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line">    <span class="message error" id="M3F1C"><span class="message error" id="M4F1C">fprintf(<span class="string">'NOTE: acceleration demanded from speed profile cannot be supplied by the set model bounds (see idx %i)\n'</span>, <span class="var type1" id="S52T46U279">overdemandAcc</span>(1))</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line">    fprintf(<span class="string">'Demanded acceleration: %4.3f\n'</span>, <span class="var type1" id="S47T24U286">accVec</span>(<span class="message error" id="M5F1C">overdemandedAcc</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line">    <span class="message error" id="M6F1C"><span class="message error" id="M7F1C">fprintf(<span class="string">'vehAccMin: %4.3\n'</span>, <span class="var type1" id="S12T32U294">fzg_scalar_struct</span>.vehAccMin)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line">    <span class="message error" id="M8F1C"><span class="message error" id="M9F1C">fprintf(<span class="string">'vehAccMax: %4.3\n'</span>, <span class="var type1" id="S12T32U301">fzg_scalar_struct</span>.vehAccMax)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line"><span class="comment">%% define battery engine value from input ratios</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line"><span class="comment">% make sure that the ratio SOC is discretized to given input energy steps</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line"><span class="var type1" id="S56T2U305">batEngBegMin</span>    = floor(<span class="var type1" id="S32T2U311">batEngMax</span>*<span class="var type1" id="S20T2U312">batEngBegMinRat</span>/<span class="var type1" id="S31T2U313">batEngStp</span>) * <span class="var type1" id="S31T2U314">batEngStp</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line"><span class="var type1" id="S58T2U317">batEngBegMax</span>    = ceil(<span class="var type1" id="S32T2U323">batEngMax</span>*<span class="var type1" id="S21T2U324">batEngBegMaxRat</span>/<span class="var type1" id="S31T2U325">batEngStp</span>) * <span class="var type1" id="S31T2U326">batEngStp</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line"><span class="comment">% select a possible for stating battery energy (random discretized value</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line"><span class="comment">% between beg_min and beg_max battery energy values</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line"><span class="var type1" id="S60T2U329">batEngBegIdx_MaxPossible</span> = (<span class="var type1" id="S58T2U332">batEngBegMax</span> - <span class="var type1" id="S56T2U333">batEngBegMin</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line"><span class="var type1" id="S61T22U336">batEngBegIdx_Possible</span>    = 0 : <span class="var type1" id="S31T2U340">batEngStp</span> : <span class="var type1" id="S60T2U341">batEngBegIdx_MaxPossible</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line"><span class="var type0" id="S62T0U344">batEngBeg</span> = <span class="var type1" id="S56T2U346">batEngBegMin</span> + <span class="var type1" id="S61T22U348">batEngBegIdx_Possible</span>(randi(numel(<span class="var type1" id="S61T22U353">batEngBegIdx_Possible</span>)));</span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line"><span class="comment">% boundary conditions the end battery energy must be within bounds of</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line"><span class="var type0" id="S65T0U356">batEngEndMin</span> = floor(<span class="var type1" id="S32T2U362">batEngMax</span>*<span class="var type1" id="S22T2U363">batEngEndMinRat</span>/<span class="var type1" id="S31T2U364">batEngStp</span>) * <span class="var type1" id="S31T2U365">batEngStp</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line"><span class="var type0" id="S66T0U368">batEngEndMax</span> = ceil(<span class="var type1" id="S32T2U374">batEngMax</span>*<span class="var type1" id="S23T2U375">batEngEndMaxRat</span>/<span class="var type1" id="S31T2U376">batEngStp</span>) * <span class="var type1" id="S31T2U377">batEngStp</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line"><span class="comment">%% Längsdynamik berechnen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line"><span class="comment">%   calculate longitundinal dynamics</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line"><span class="comment">% Steigungskraft aus der mittleren Steigung berechnen (Skalar)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line"><span class="comment">%   gradiant force from the calculated (average) gradient</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line"><span class="var type1" id="S67T24U380">vehFrcSlp</span> = <span class="var type1" id="S12T32U384">fzg_scalar_struct</span>.vehMas * 9.81 * sin(<span class="var type1" id="S48T24U389">slopeVec</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line"><span class="comment">% Rollreibungskraft berechnen (Skalar)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line"><span class="comment">%   calculated rolling friction force - not included in EQ 5???</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line"><span class="var type1" id="S69T24U392">vehFrcRol</span> = <span class="var type1" id="S12T32U397">fzg_scalar_struct</span>.whlRosResCof*<span class="var type1" id="S12T32U400">fzg_scalar_struct</span>.vehMas * 9.81 * cos(<span class="var type1" id="S48T24U405">slopeVec</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line"><span class="comment">% Luftwiderstandskraft berechnen (2*c_a/m * E_kin) (Skalar) </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line"><span class="comment">%   calculated air resistance force </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line"><span class="var type1" id="S71T24U408">vehFrcDrg</span> = <span class="var type1" id="S12T32U411">fzg_scalar_struct</span>.drgCof * <span class="var type1" id="S46T24U414">velVec</span>.^2;</span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line"><span class="comment">%% Berechnen der Kraft am Rad fÃ¼r Antriebsstrangmodus</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line"><span class="comment">%   calculate the force on the wheel for the drivetrain mode</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line"><span class="comment">% Radkraft berechnen (Beschleunigungskraft + Steigungskraft +</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line"><span class="comment">% Rollwiderstandskraft + Luftwiderstandskraft)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line"><span class="comment">%   caluclating wheel forces (accerlation force + gradient force + rolling</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line"><span class="comment">%   resistance + air resistance)    EQUATION 5</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line"><span class="var type1" id="S72T24U418">whlFrc</span>  = <span class="var type1" id="S47T24U423">accVec</span>*<span class="var type1" id="S12T32U425">fzg_scalar_struct</span>.vehMas + <span class="var type1" id="S67T24U427">vehFrcSlp</span> + <span class="var type1" id="S69T24U428">vehFrcRol</span> + <span class="var type1" id="S71T24U429">vehFrcDrg</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line"><span class="comment">% side note: if vehicle velocity is zero, then set force at wheel to zero</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line"><span class="var type1" id="S72T24U433">whlFrc</span>(<span class="var type1" id="S46T24U435">velVec</span> &lt; 0.05) = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line"><span class="comment">% Das Drehmoment des Rades ergibt sich Ã¼ber den Radhalbmesser aus</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line"><span class="comment">% der Fahrwiderstandskraft.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line"><span class="comment">%   the weel torque is obtained from the wheel radius of the rolling</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line"><span class="comment">%   resistance force (torque = force * distance (in this case, radius)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line"><span class="var type0" id="S73T0U440">whlTrq</span> = <span class="var type1" id="S72T24U442">whlFrc</span>*<span class="var type1" id="S12T32U444">fzg_scalar_struct</span>.whlDrr;</span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line"><span class="comment">%% create equidistant speed-torque boundary ranges</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line"><span class="comment">% define a bool for always finding and using equidistant bounds</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line"><span class="comment">%   incorporate into mainConfig.txt later</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line"><span class="var type1" id="S74T2U448">useEqiDis</span> = 1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S74T2U452">useEqiDis</span> </span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line">    <span class="comment">% for ICE</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line">    <span class="var type1" id="S75T86U455">iceSpdDif</span> = diff(<span class="var type1" id="S14T71U459">fzg_array_struct</span>.iceSpdMgd);</span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line">    <span class="keyword">if</span> any(abs(diff(<span class="var type1" id="S75T86U470">iceSpdDif</span>)) &gt; 0.005)</span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line">        <span class="comment">% equidistant interpolation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line">        <span class="keyword">if</span> <span class="var type1" id="S18T2U474">iceExtBool</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line">            <span class="var type1" id="S78T22U477">iceSpdInterp</span>    = <span class="var type1" id="S75T86U481">iceSpdDif</span>(2) : <span class="var type1" id="S75T86U484">iceSpdDif</span>(2) : <span class="var type1" id="S14T71U488">fzg_array_struct</span>.iceSpdMgd(end);</span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line">            fprintf(<span class="string">'NOTE: ICE boundaries have been extrapolated to crsSpd = 0\n'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line">        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line">            <span class="var type1" id="S78T22U499">iceSpdInterp</span>    = <span class="var type1" id="S14T71U504">fzg_array_struct</span>.iceSpdMgd(1) : <span class="var type1" id="S75T86U508">iceSpdDif</span>(1) : <span class="var type1" id="S14T71U512">fzg_array_struct</span>.iceSpdMgd(end);</span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line">        <span class="var type1" id="S79T22U518">iceTrqMaxInterp</span> = interp1(<span class="var type1" id="S14T71U522">fzg_array_struct</span>.iceSpdMgd, <span class="var type1" id="S14T71U526">fzg_array_struct</span>.iceTrqMax_emoSpd(:,2), <span class="var type1" id="S78T22U530">iceSpdInterp</span>, <span class="string">'linear'</span>, <span class="string">'extrap'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line">        <span class="var type1" id="S81T22U535">iceTrqMinInterp</span> = interp1(<span class="var type1" id="S14T71U539">fzg_array_struct</span>.iceSpdMgd, <span class="var type1" id="S14T71U543">fzg_array_struct</span>.iceTrqMin_emoSpd(:,2), <span class="var type1" id="S78T22U547">iceSpdInterp</span>, <span class="string">'linear'</span>, <span class="string">'extrap'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line">        <span class="var type1" id="S82T22U552">icePwrInterp</span> = interp2(<span class="var type1" id="S14T71U556">fzg_array_struct</span>.iceSpdMgd, <span class="var type1" id="S14T71U559">fzg_array_struct</span>.iceTrqMgd, <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line">                                <span class="var type1" id="S14T71U562">fzg_array_struct</span>.iceFulPwr_iceSpd_iceTrq, <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line">                                <span class="var type1" id="S78T22U564">iceSpdInterp</span>, <span class="var type1" id="S14T71U566">fzg_array_struct</span>.iceTrqMgd);</span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line">                            </span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line">        <span class="comment">% save equidistant interpolation values into the parameter structure</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line">        <span class="message error" id="M10F1C"><span class="var type1" id="S14T71U571">fzg_array_struct</span>.iceSpdMgd</span>               = <span class="var type1" id="S78T22U573">iceSpdInterp</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line">        <span class="message error" id="M11F1C"><span class="var type1" id="S14T71U577">fzg_array_struct</span>.iceFulPwr_iceSpd_iceTrq</span> = <span class="var type1" id="S82T22U579">icePwrInterp</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line">        <span class="message error" id="M12F1C"><span class="var type1" id="S14T71U583">fzg_array_struct</span>.iceTrqMax_emoSpd</span>        = [<span class="var type1" id="S78T22U588">iceSpdInterp</span>' <span class="var type1" id="S79T22U590">iceTrqMaxInterp</span>'];</span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line">        <span class="message error" id="M13F1C"><span class="var type1" id="S14T71U594">fzg_array_struct</span>.iceTrqMin_emoSpd</span>        = [<span class="var type1" id="S78T22U599">iceSpdInterp</span>' <span class="var type1" id="S81T22U601">iceTrqMinInterp</span>'];</span></span>
<span class="srcline"><span class="lineno"><a href="1,160" id="srcline160">160</a></span><span class="line">        fprintf(<span class="string">'NOTE: Interpolated ICE boundaries to be equidistant\n'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,161" id="srcline161">161</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,162" id="srcline162">162</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,163" id="srcline163">163</a></span><span class="line">    <span class="comment">% for EM</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,164" id="srcline164">164</a></span><span class="line">    <span class="var type1" id="S84T107U608">emoSpdDif</span> = diff(<span class="var type1" id="S14T71U612">fzg_array_struct</span>.emoSpdMgd);</span></span>
<span class="srcline"><span class="lineno"><a href="1,165" id="srcline165">165</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,166" id="srcline166">166</a></span><span class="line">    <span class="keyword">if</span> any(abs(diff(<span class="var type1" id="S84T107U623">emoSpdDif</span>)) &gt; 0.005)</span></span>
<span class="srcline"><span class="lineno"><a href="1,167" id="srcline167">167</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,168" id="srcline168">168</a></span><span class="line">        <span class="comment">% equidistant interpolation+ extrapolation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,169" id="srcline169">169</a></span><span class="line">        <span class="comment">% will be artifically capping min/max bounds @emoTrqMax/Min_emoSpd(1,2) to</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,170" id="srcline170">170</a></span><span class="line">        <span class="comment">% all crankshaft indexes between 0 and emoTrqMax/Min_emoSpd(1,1)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,171" id="srcline171">171</a></span><span class="line">        <span class="var type1" id="S85T22U627">emoSpdInterp</span>    = <span class="var type1" id="S14T71U632">fzg_array_struct</span>.emoSpdMgd(1) : <span class="var type1" id="S84T107U636">emoSpdDif</span>(2) : <span class="var type1" id="S14T71U640">fzg_array_struct</span>.emoSpdMgd(end);</span></span>
<span class="srcline"><span class="lineno"><a href="1,172" id="srcline172">172</a></span><span class="line">        <span class="var type1" id="S86T22U646">emoTrqMaxInterp</span> = interp1(<span class="var type1" id="S14T71U651">fzg_array_struct</span>.emoTrqMax_emoSpd(:,1), <span class="var type1" id="S14T71U657">fzg_array_struct</span>.emoTrqMax_emoSpd(:,2), <span class="var type1" id="S85T22U661">emoSpdInterp</span>, <span class="string">'linear'</span>, <span class="string">'extrap'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,173" id="srcline173">173</a></span><span class="line">        <span class="var type1" id="S87T22U666">emoTrqMinInterp</span> = interp1(<span class="var type1" id="S14T71U671">fzg_array_struct</span>.emoTrqMin_emoSpd(:,1), <span class="var type1" id="S14T71U677">fzg_array_struct</span>.emoTrqMin_emoSpd(:,2), <span class="var type1" id="S85T22U681">emoSpdInterp</span>, <span class="string">'linear'</span>, <span class="string">'extrap'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,174" id="srcline174">174</a></span><span class="line">        <span class="var type1" id="S88T22U686">emoPwrMaxInterp</span> = interp1(<span class="var type1" id="S14T71U691">fzg_array_struct</span>.emoPwrMax_emoSpd(:,1), <span class="var type1" id="S14T71U697">fzg_array_struct</span>.emoPwrMax_emoSpd(:,2), <span class="var type1" id="S85T22U701">emoSpdInterp</span>, <span class="string">'linear'</span>, <span class="string">'extrap'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,175" id="srcline175">175</a></span><span class="line">        <span class="var type1" id="S89T22U706">emoPwrMinInterp</span> = interp1(<span class="var type1" id="S14T71U711">fzg_array_struct</span>.emoPwrMin_emoSpd(:,1), <span class="var type1" id="S14T71U717">fzg_array_struct</span>.emoPwrMin_emoSpd(:,2), <span class="var type1" id="S85T22U721">emoSpdInterp</span>, <span class="string">'linear'</span>, <span class="string">'extrap'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,176" id="srcline176">176</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,177" id="srcline177">177</a></span><span class="line">        <span class="comment">% IGNOREING emoTrq-&gt;emoPwr boundareis for the moment - too many NaNs for</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,178" id="srcline178">178</a></span><span class="line">        <span class="comment">% the interpolated data to make sense, will need to talk about over again</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,179" id="srcline179">179</a></span><span class="line">        <span class="comment">% later</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,180" id="srcline180">180</a></span><span class="line">        <span class="comment">% % derive the emoPwr needed by emoTrq limits - leave NaNs as NaNs</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,181" id="srcline181">181</a></span><span class="line">        <span class="comment">% %   is not efficient, but it's just a one tim preprocessing deal</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,182" id="srcline182">182</a></span><span class="line">        <span class="comment">% % emoPwrNanDerive = inpaint_nans(fzg_array_struct.emoPwr_emoSpd_emoTrq);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,183" id="srcline183">183</a></span><span class="line">        <span class="comment">% emoPwrNanDerive = inpaint_nans(fzg_array_struct.emoPwr_emoSpd_emoTrq, 3);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,184" id="srcline184">184</a></span><span class="line">        <span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,185" id="srcline185">185</a></span><span class="line"><span class="comment">%         emoPwrMinDerive = zeros(size(fzg_array_struct.emoPwr_emoSpd_emoTrq));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,186" id="srcline186">186</a></span><span class="line"><span class="comment">%         emoPwrMaxDerive1 = interp2(fzg_array_struct.emoSpdMgd, fzg_array_struct.emoTrqMgd, <span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,187" id="srcline187">187</a></span><span class="line"><span class="comment">%                         fzg_array_struct.emoPwr_emoSpd_emoTrq, emoSpdInterp, fzg_array_struct.emoTrqMgd, 'linear');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,188" id="srcline188">188</a></span><span class="line">        <span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,189" id="srcline189">189</a></span><span class="line">        <span class="comment">% emoPwrMaxDerive2 = interp2(fzg_array_struct.emoSpdMgd, fzg_array_struct.emoTrqMgd,<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,190" id="srcline190">190</a></span><span class="line">        <span class="comment">%                 emoPwrNanDerive, emoSpdInterp, emoTrqMaxInterp, 'linear');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,191" id="srcline191">191</a></span><span class="line">        <span class="comment">%             </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,192" id="srcline192">192</a></span><span class="line">        <span class="comment">% % emoPwrMinDerive = zeros(size(fzg_array_struct.emoPwr_emoSpd_emoTrq));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,193" id="srcline193">193</a></span><span class="line">        <span class="comment">% emoPwrMinDerive1 = interp2(fzg_array_struct.emoSpdMgd, fzg_array_struct.emoTrqMgd, <span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,194" id="srcline194">194</a></span><span class="line">        <span class="comment">%                 fzg_array_struct.emoPwr_emoSpd_emoTrq, emoSpdInterp, emoTrqMinInterp, 'linear');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,195" id="srcline195">195</a></span><span class="line">        <span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,196" id="srcline196">196</a></span><span class="line">        <span class="comment">% emoPwrMinDerive2 = interp2(fzg_array_struct.emoSpdMgd, fzg_array_struct.emoTrqMgd,<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,197" id="srcline197">197</a></span><span class="line">        <span class="comment">%                 emoPwrNanDerive, emoSpdInterp, emoTrqMinInterp, 'linear');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,198" id="srcline198">198</a></span><span class="line">        <span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,199" id="srcline199">199</a></span><span class="line">        <span class="comment">% emoPwrMax</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,200" id="srcline200">200</a></span><span class="line">        <span class="comment">%             </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,201" id="srcline201">201</a></span><span class="line">        <span class="comment">% for i = 1 : length(fzg_array_struct.emoPwr_emoSpd_emoTrq(1,:)) % spd loop</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,202" id="srcline202">202</a></span><span class="line">        <span class="comment">%     for j = 1 : length(fzg_array_struct.emoPwr_emoSpd_emoTrq(:,1))%trq loop</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,203" id="srcline203">203</a></span><span class="line">        <span class="comment">%         if ~isnan(fzg_array_struct.emoPwr_emoSpd_emoTrq(j,i))</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,204" id="srcline204">204</a></span><span class="line">        <span class="comment">%             emoPwrMinDerive(j,i) = interp2(fzg_array_struct.emoSpdMgd, fzg_array_struct.emoTrqMgd, <span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,205" id="srcline205">205</a></span><span class="line">        <span class="comment">%                 fzg_array_struct.emoPwr_emoSpd_emoTrq, emoSpdInterp(i), emoTrqMaxInterp(j), 'linear');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,206" id="srcline206">206</a></span><span class="line">        <span class="comment">%         else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,207" id="srcline207">207</a></span><span class="line">        <span class="comment">%             emoPwrMinDerive(j,i) = NaN;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,208" id="srcline208">208</a></span><span class="line">        <span class="comment">%         end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,209" id="srcline209">209</a></span><span class="line">        <span class="comment">%     end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,210" id="srcline210">210</a></span><span class="line">        <span class="comment">% end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,211" id="srcline211">211</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,212" id="srcline212">212</a></span><span class="line">        <span class="comment">% fzg_array_struct.emoTrqMgd, fzg_array_struct.emoSpdMgd(1,:)', <span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,213" id="srcline213">213</a></span><span class="line">        <span class="comment">%                     fzg_array_struct.emoPwr_emoSpd_emoTrq</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,214" id="srcline214">214</a></span><span class="line">        <span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,215" id="srcline215">215</a></span><span class="line">        <span class="comment">% fzg_array_struct.emoPwr_emoSpd_emoTrq</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,216" id="srcline216">216</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,217" id="srcline217">217</a></span><span class="line">        <span class="comment">% artifical min/max cap from speed values from 0:emoTrq_emoSpd(1,1)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,218" id="srcline218">218</a></span><span class="line">        <span class="var type0" id="S90T0U726">emoSpdCapIdx</span> = (<span class="message error" id="M14F1C"><span class="message error" id="M15F1C"><span class="var type1" id="S14T71U733">fzg_array_struct</span>.emoSpdMgd(1)/<span class="var type1" id="S84T107U737">emoSpdDif</span>(2) : <span class="var type1" id="S14T71U742">fzg_array_struct</span>.emoTrqMax_emoSpd(:,1)/<span class="var type1" id="S84T107U747">emoSpdDif</span>(2)</span></span>)+1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,219" id="srcline219">219</a></span><span class="line">        <span class="var type1" id="S86T22U753">emoTrqMaxInterp</span>(<span class="var type0" id="S90T0U754"><span class="message error" id="M17F1C">emoSpdCapIdx</span></span>) = <span class="var type1" id="S14T71U757">fzg_array_struct</span>.emoTrqMax_emoSpd(1,2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,220" id="srcline220">220</a></span><span class="line">        <span class="var type1" id="S87T22U764">emoTrqMinInterp</span>(<span class="var type0" id="S90T0U765"><span class="message error" id="M19F1C">emoSpdCapIdx</span></span>) = <span class="var type1" id="S14T71U768">fzg_array_struct</span>.emoTrqMin_emoSpd(1,2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,221" id="srcline221">221</a></span><span class="line">        <span class="var type1" id="S88T22U775">emoPwrMaxInterp</span>(<span class="var type0" id="S90T0U776"><span class="message error" id="M21F1C">emoSpdCapIdx</span></span>) = <span class="var type1" id="S14T71U779">fzg_array_struct</span>.emoPwrMax_emoSpd(1,2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,222" id="srcline222">222</a></span><span class="line">        <span class="var type1" id="S89T22U786">emoPwrMinInterp</span>(<span class="var type0" id="S90T0U787"><span class="message error" id="M23F1C">emoSpdCapIdx</span></span>) = <span class="var type1" id="S14T71U790">fzg_array_struct</span>.emoPwrMin_emoSpd(1,2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,223" id="srcline223">223</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,224" id="srcline224">224</a></span><span class="line">        <span class="comment">% save equidistant interpolation values into the parameter structure</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,225" id="srcline225">225</a></span><span class="line">        <span class="message error" id="M16F1C"><span class="var type1" id="S14T71U797">fzg_array_struct</span>.emoSpdMgd</span>          = <span class="var type1" id="S85T22U799">emoSpdInterp</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,226" id="srcline226">226</a></span><span class="line">        <span class="message error" id="M18F1C"><span class="var type1" id="S14T71U803">fzg_array_struct</span>.emoTrqMax_emoSpd</span>   = [<span class="var type1" id="S85T22U808">emoSpdInterp</span>', <span class="var type1" id="S86T22U810">emoTrqMaxInterp</span>'];</span></span>
<span class="srcline"><span class="lineno"><a href="1,227" id="srcline227">227</a></span><span class="line">        <span class="message error" id="M20F1C"><span class="var type1" id="S14T71U814">fzg_array_struct</span>.emoTrqMin_emoSpd</span>   = [<span class="var type1" id="S85T22U819">emoSpdInterp</span>', <span class="var type1" id="S87T22U821">emoTrqMinInterp</span>'];</span></span>
<span class="srcline"><span class="lineno"><a href="1,228" id="srcline228">228</a></span><span class="line">        <span class="message error" id="M22F1C"><span class="var type1" id="S14T71U825">fzg_array_struct</span>.emoPwrMax_emoSpd</span>   = [<span class="var type1" id="S85T22U830">emoSpdInterp</span>', <span class="var type1" id="S88T22U832">emoPwrMaxInterp</span>'];</span></span>
<span class="srcline"><span class="lineno"><a href="1,229" id="srcline229">229</a></span><span class="line">        <span class="message fatal" id="M24F1C"><span class="var type1" id="S14T71U836">fzg_array_struct</span>.emoPwrMin_emoSpd</span>   = [<span class="var type1" id="S85T22U841">emoSpdInterp</span>', <span class="var type1" id="S89T22U843">emoPwrMinInterp</span>'];</span></span>
<span class="srcline"><span class="lineno"><a href="1,230" id="srcline230">230</a></span><span class="line">        fprintf(<span class="string">'NOTE: Interpolated EM boundaries to be equidistant\n'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,231" id="srcline231">231</a></span><span class="line">    <span class="keyword">end</span> </span></span>
<span class="srcline"><span class="lineno"><a href="1,232" id="srcline232">232</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,233" id="srcline233">233</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,234" id="srcline234">234</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,235" id="srcline235">235</a></span><span class="line"><span class="comment">%% DEFINE ICE/EM BOUNDARIES BASED ON CRANKSHAFT SPEED</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,236" id="srcline236">236</a></span><span class="line"><span class="comment">% The ICE and EM can provide a max and min torque for a given crankshaft</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,237" id="srcline237">237</a></span><span class="line"><span class="comment">%   speed due to physical limitations.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,238" id="srcline238">238</a></span><span class="line"><span class="comment">% These physical boundaries are already given as vector inputs accross </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,239" id="srcline239">239</a></span><span class="line"><span class="comment">%   various intermittant crankshaft speeds.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,240" id="srcline240">240</a></span><span class="line"><span class="comment">% Therefore, this snippet of code interpolates this torque boundary vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,241" id="srcline241">241</a></span><span class="line"><span class="comment">%   accross the entirty of the crankshaft speed vector demanded by the speed </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,242" id="srcline242">242</a></span><span class="line"><span class="comment">%   profile accross all gear states.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,243" id="srcline243">243</a></span><span class="line"><span class="comment">% These interpolations are done in a loop going through all possible</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,244" id="srcline244">244</a></span><span class="line"><span class="comment">%   crankshaft speeds defined per gear state variable.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,245" id="srcline245">245</a></span><span class="line"><span class="comment">% The above process is also done for EM power boundaries.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,246" id="srcline246">246</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,247" id="srcline247">247</a></span><span class="line"><span class="comment">% preallocation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,248" id="srcline248">248</a></span><span class="line"><span class="var type0" id="S91T0U850">crsSpdMat</span>       = zeros(length(<span class="var type0" id="S46T0U855">velVec</span>), <span class="var type0" id="S34T0U856">geaStaNum</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,249" id="srcline249">249</a></span><span class="line"><span class="var type0" id="S93T0U859">crsTrqMat</span>       = repmat(<span class="var type0" id="S73T0U862">whlTrq</span>, 1, <span class="var type0" id="S34T0U864">geaStaNum</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,250" id="srcline250">250</a></span><span class="line"><span class="var type0" id="S95T0U867">iceTrqMaxPosMat</span> = zeros(length(<span class="var type0" id="S46T0U872">velVec</span>), <span class="var type0" id="S34T0U873">geaStaNum</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,251" id="srcline251">251</a></span><span class="line"><span class="var type0" id="S96T0U876">iceTrqMinPosMat</span> = zeros(length(<span class="var type0" id="S46T0U881">velVec</span>), <span class="var type0" id="S34T0U882">geaStaNum</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,252" id="srcline252">252</a></span><span class="line"><span class="var type0" id="S97T0U885">emoTrqMaxPosMat</span> = zeros(length(<span class="var type0" id="S46T0U890">velVec</span>), <span class="var type0" id="S34T0U891">geaStaNum</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,253" id="srcline253">253</a></span><span class="line"><span class="var type0" id="S98T0U894">emoTrqMinPosMat</span> = zeros(length(<span class="var type0" id="S46T0U899">velVec</span>), <span class="var type0" id="S34T0U900">geaStaNum</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,254" id="srcline254">254</a></span><span class="line"><span class="var type0" id="S99T0U903">emoPwrMinPosMat</span> = zeros(length(<span class="var type0" id="S46T0U908">velVec</span>), <span class="var type0" id="S34T0U909">geaStaNum</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,255" id="srcline255">255</a></span><span class="line"><span class="var type0" id="S100T0U912">emoPwrMaxPosMat</span> = zeros(length(<span class="var type0" id="S46T0U917">velVec</span>), <span class="var type0" id="S34T0U918">geaStaNum</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,256" id="srcline256">256</a></span><span class="line"><span class="comment">% emoPwrMinMat    = zeros(length(velVec), geaStaNum);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,257" id="srcline257">257</a></span><span class="line"><span class="comment">% emoPwrMaxMat    = zeros(length(velVec), geaStaNum);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,258" id="srcline258">258</a></span><span class="line"><span class="comment">% ---- LOOP THROUGH GEAR STATES -----------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,259" id="srcline259">259</a></span><span class="line"><span class="keyword">for</span> <span class="var type0" id="S101T0U921">gea</span> = 1 : <span class="var type0" id="S34T0U924">geaStaNum</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,260" id="srcline260">260</a></span><span class="line">    <span class="comment">% CALCULATE CRANKSHAFT SPEEDS</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,261" id="srcline261">261</a></span><span class="line">    <span class="comment">% In order to calculate crsSpd-based boundaries, crsSpd must be found first</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,262" id="srcline262">262</a></span><span class="line">    <span class="comment">% calc crsSpd matrix along speed profile - a speed column for each gear</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,263" id="srcline263">263</a></span><span class="line">    <span class="var type0" id="S91T0U928">crsSpdMat</span>(:, <span class="var type0" id="S101T0U930">gea</span>)       = <span class="var type0" id="S14T0U935">fzg_array_struct</span>.geaRat(<span class="var type0" id="S101T0U937">gea</span>) * <span class="var type0" id="S46T0U938">velVec</span> / (<span class="var type0" id="S12T0U941">fzg_scalar_struct</span>.whlDrr);</span></span>
<span class="srcline"><span class="lineno"><a href="1,264" id="srcline264">264</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,265" id="srcline265">265</a></span><span class="line">    <span class="comment">% CALCULATE ICE MAX/MIN TORQUE BOUNDARIES</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,266" id="srcline266">266</a></span><span class="line">    <span class="comment">% max torque that ice can provide at current crsSpd - from interpolation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,267" id="srcline267">267</a></span><span class="line">    <span class="var type0" id="S95T0U946">iceTrqMaxPosMat</span>(:, <span class="var type0" id="S101T0U948">gea</span>) = interp1q(<span class="var type0" id="S14T0U954">fzg_array_struct</span>.iceSpdMgd(1,:)',        <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,268" id="srcline268">268</a></span><span class="line">                                        <span class="var type0" id="S14T0U960">fzg_array_struct</span>.iceTrqMax_emoSpd(:,2), <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,269" id="srcline269">269</a></span><span class="line">                                        <span class="var type0" id="S91T0U965">crsSpdMat</span>(:, <span class="var type0" id="S101T0U967">gea</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,270" id="srcline270">270</a></span><span class="line">    <span class="comment">% min torque that ice can provide at current crsSpd - from interpolation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,271" id="srcline271">271</a></span><span class="line">    <span class="var type0" id="S96T0U971">iceTrqMinPosMat</span>(:, <span class="var type0" id="S101T0U973">gea</span>) = interp1q(<span class="var type0" id="S14T0U979">fzg_array_struct</span>.iceSpdMgd(1,:)',        <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,272" id="srcline272">272</a></span><span class="line">                                        <span class="var type0" id="S14T0U985">fzg_array_struct</span>.iceTrqMin_emoSpd(:,2), <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,273" id="srcline273">273</a></span><span class="line">                                        <span class="var type0" id="S91T0U990">crsSpdMat</span>(:, <span class="var type0" id="S101T0U992">gea</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,274" id="srcline274">274</a></span><span class="line">                                    </span></span>
<span class="srcline"><span class="lineno"><a href="1,275" id="srcline275">275</a></span><span class="line">    <span class="comment">% CALCULATE EM MAX/MIN TORQUE BOUNDARIES                                </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,276" id="srcline276">276</a></span><span class="line">    <span class="comment">% max torque that the electric motor can provide - from interpolation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,277" id="srcline277">277</a></span><span class="line">    <span class="var type0" id="S97T0U996">emoTrqMaxPosMat</span>(:, <span class="var type0" id="S101T0U998">gea</span>) = interp1q(<span class="var type0" id="S14T0U1004">fzg_array_struct</span>.emoSpdMgd(1,:)',        <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,278" id="srcline278">278</a></span><span class="line">                                        <span class="var type0" id="S14T0U1010">fzg_array_struct</span>.emoTrqMax_emoSpd(:,2), <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,279" id="srcline279">279</a></span><span class="line">                                        <span class="var type0" id="S91T0U1015">crsSpdMat</span>(:, <span class="var type0" id="S101T0U1017">gea</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,280" id="srcline280">280</a></span><span class="line">    <span class="var type0" id="S98T0U1021">emoTrqMinPosMat</span>(:, <span class="var type0" id="S101T0U1023">gea</span>) = interp1q(<span class="var type0" id="S14T0U1029">fzg_array_struct</span>.emoSpdMgd(1,:)',        <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,281" id="srcline281">281</a></span><span class="line">                                        <span class="var type0" id="S14T0U1035">fzg_array_struct</span>.emoTrqMin_emoSpd(:,2), <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,282" id="srcline282">282</a></span><span class="line">                                        <span class="var type0" id="S91T0U1040">crsSpdMat</span>(:, <span class="var type0" id="S101T0U1042">gea</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,283" id="srcline283">283</a></span><span class="line">                                    </span></span>
<span class="srcline"><span class="lineno"><a href="1,284" id="srcline284">284</a></span><span class="line">    <span class="comment">% CALCULATE EM PWR MIN/MAX BOUNDARIES                                </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,285" id="srcline285">285</a></span><span class="line">    <span class="var type0" id="S99T0U1046">emoPwrMinPosMat</span>(:, <span class="var type0" id="S101T0U1048">gea</span>) = interp1q(<span class="var type0" id="S14T0U1054">fzg_array_struct</span>.emoSpdMgd(1,:)',        <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,286" id="srcline286">286</a></span><span class="line">                                        <span class="var type0" id="S14T0U1060">fzg_array_struct</span>.emoPwrMin_emoSpd(:,2), <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,287" id="srcline287">287</a></span><span class="line">                                        <span class="var type0" id="S91T0U1065">crsSpdMat</span>(:, <span class="var type0" id="S101T0U1067">gea</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,288" id="srcline288">288</a></span><span class="line">    <span class="var type0" id="S100T0U1071">emoPwrMaxPosMat</span>(:, <span class="var type0" id="S101T0U1073">gea</span>) = interp1q(<span class="var type0" id="S14T0U1079">fzg_array_struct</span>.emoSpdMgd(1,:)',        <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,289" id="srcline289">289</a></span><span class="line">                                        <span class="var type0" id="S14T0U1085">fzg_array_struct</span>.emoPwrMax_emoSpd(:,2), <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,290" id="srcline290">290</a></span><span class="line">                                        <span class="var type0" id="S91T0U1090">crsSpdMat</span>(:, <span class="var type0" id="S101T0U1092">gea</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,291" id="srcline291">291</a></span><span class="line">                                    </span></span>
<span class="srcline"><span class="lineno"><a href="1,292" id="srcline292">292</a></span><span class="line">    <span class="comment">% CALCULATE CRANKSHAFT TORQUE</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,293" id="srcline293">293</a></span><span class="line">    <span class="comment">% Also calculate crsTrq which is based on crsSpd</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,294" id="srcline294">294</a></span><span class="line">    <span class="comment">% calc torque matrix - a torque column for each gear</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,295" id="srcline295">295</a></span><span class="line">    <span class="comment">% take into account if torque is + or - : they have diff eqs</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,296" id="srcline296">296</a></span><span class="line">    <span class="var type0" id="S103T0U1095">crsTrqTmp</span> = <span class="var type0" id="S93T0U1097">crsTrqMat</span>(:, <span class="var type0" id="S101T0U1099">gea</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,297" id="srcline297">297</a></span><span class="line">    <span class="var type0" id="S103T0U1103">crsTrqTmp</span>(<span class="var type0" id="S103T0U1105">crsTrqTmp</span>&lt;0)  = <span class="var type0" id="S73T0U1110">whlTrq</span>(<span class="var type0" id="S103T0U1112">crsTrqTmp</span>&lt;0) / <span class="var type0" id="S14T0U1116">fzg_array_struct</span>.geaRat(<span class="var type0" id="S101T0U1118">gea</span>) * <span class="var type0" id="S14T0U1121">fzg_array_struct</span>.geaEfy(<span class="var type0" id="S101T0U1123">gea</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,298" id="srcline298">298</a></span><span class="line">    <span class="var type0" id="S103T0U1127">crsTrqTmp</span>(<span class="var type0" id="S103T0U1129">crsTrqTmp</span>&gt;=0) = <span class="var type0" id="S73T0U1134">whlTrq</span>(<span class="var type0" id="S103T0U1136">crsTrqTmp</span>&gt;=0) / <span class="var type0" id="S14T0U1140">fzg_array_struct</span>.geaRat(<span class="var type0" id="S101T0U1142">gea</span>) / <span class="var type0" id="S14T0U1145">fzg_array_struct</span>.geaEfy(<span class="var type0" id="S101T0U1147">gea</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,299" id="srcline299">299</a></span><span class="line">    <span class="var type0" id="S93T0U1151">crsTrqMat</span>(:, <span class="var type0" id="S101T0U1153">gea</span>) = <span class="var type0" id="S103T0U1154">crsTrqTmp</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,300" id="srcline300">300</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,301" id="srcline301">301</a></span><span class="line"><span class="comment">% -----------------------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,302" id="srcline302">302</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,303" id="srcline303">303</a></span><span class="line"><span class="comment">%% GENERATE POWER DEMAND PROFILE THAT MUST BE SATISFIED</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,304" id="srcline304">304</a></span><span class="line"><span class="comment">% crsTrq * crsSpd = crsPwr &lt;- demand must be satisfied to complete profile</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,305" id="srcline305">305</a></span><span class="line"><span class="var type0" id="S104T0U1157">crsPwrMat</span> = <span class="var type0" id="S93T0U1159">crsTrqMat</span> .* <span class="var type0" id="S91T0U1160">crsSpdMat</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,306" id="srcline306">306</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,307" id="srcline307">307</a></span><span class="line"><span class="comment">% % %% set emo power bounds</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,308" id="srcline308">308</a></span><span class="line"><span class="comment">% % % These power lookups are based on both speed AND torque - given vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,309" id="srcline309">309</a></span><span class="line"><span class="comment">% % % boundary input for the model.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,310" id="srcline310">310</a></span><span class="line"><span class="comment">% % % Is not related to the boudaries set by max/min crankshaft speed above.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,311" id="srcline311">311</a></span><span class="line"><span class="comment">% % % This matrix defines the torque-speed curve for EM power.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,312" id="srcline312">312</a></span><span class="line"><span class="comment">% % %</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,313" id="srcline313">313</a></span><span class="line"><span class="comment">% % % Since the entire crankshaft speed and torque values for the speed profile </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,314" id="srcline314">314</a></span><span class="line"><span class="comment">% % % across all gears have been calculated in the previous code snippet, can</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,315" id="srcline315">315</a></span><span class="line"><span class="comment">% % % the </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,316" id="srcline316">316</a></span><span class="line"><span class="comment">% % % first derive emoPwr based on emoTrq bounds</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,317" id="srcline317">317</a></span><span class="line"><span class="comment">% NOTE: THIS IS A LOOKUP TABLE, NOT A BOUDNARY CALCULATION!- abort?</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,318" id="srcline318">318</a></span><span class="line"><span class="comment">% % emoPwrMin = interp2(fzg_array_struct.emoTrqMgd, fzg_array_struct.emoSpdMgd(1,:)', <span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,319" id="srcline319">319</a></span><span class="line"><span class="comment">% %                     fzg_array_struct.emoPwr_emoSpd_emoTrq, <span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,320" id="srcline320">320</a></span><span class="line"><span class="comment">% %                     emoTrqMinPosMat(:, gea), crsSpdMat(:, gea));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,321" id="srcline321">321</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,322" id="srcline322">322</a></span><span class="line"><span class="comment">%% calculating max/min batPwr demanded wrt emoPwrMax/MinPos above</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,323" id="srcline323">323</a></span><span class="line"><span class="comment">% this batPwr will help minimize which batEng states to loop through in DP</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,324" id="srcline324">324</a></span><span class="line"><span class="comment">% note: boundaries have been discretized to the tim index step size in the</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,325" id="srcline325">325</a></span><span class="line"><span class="comment">% previous code snippet.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,326" id="srcline326">326</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,327" id="srcline327">327</a></span><span class="line"><span class="comment">% EQUATION</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,328" id="srcline328">328</a></span><span class="line"><span class="comment">%       batPwr - batPwrLoss = emoPwr</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,329" id="srcline329">329</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,330" id="srcline330">330</a></span><span class="line"><span class="comment">% where,</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,331" id="srcline331">331</a></span><span class="line"><span class="comment">%       emoPwr is given (min/max boundary vectors above - emoPwrMax/Min_emoSpd)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,332" id="srcline332">332</a></span><span class="line"><span class="comment">%       batPwrLoss = I^2*batRst,</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,333" id="srcline333">333</a></span><span class="line"><span class="comment">%       batPwr     = V*I, and</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,334" id="srcline334">334</a></span><span class="line"><span class="comment">%       Voltage V is a function of batEng (will be looped through)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,335" id="srcline335">335</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,336" id="srcline336">336</a></span><span class="line"><span class="comment">% rearranging the above equations, batPwrLoss can be found as:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,337" id="srcline337">337</a></span><span class="line"><span class="comment">%       batPwrLoss = ((V-sqrt(V^2 - 4*R*emoPwr))^2)/(4*R)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,338" id="srcline338">338</a></span><span class="line"><span class="comment">% from which then batPwr can then be easily found (rearranging EQUATION):</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,339" id="srcline339">339</a></span><span class="line"><span class="comment">%       batPwr = emoPwr + batPwrLoss</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,340" id="srcline340">340</a></span><span class="line"><span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,341" id="srcline341">341</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,342" id="srcline342">342</a></span><span class="line"><span class="comment">% also calculating the battery power needed at each possible crankshaft </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,343" id="srcline343">343</a></span><span class="line"><span class="comment">% power occurance (ie the electric battery energy difference that must </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,344" id="srcline344">344</a></span><span class="line"><span class="comment">% occur if the battery supplies all the power to satisfy each crankshaft </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,345" id="srcline345">345</a></span><span class="line"><span class="comment">% power demand)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,346" id="srcline346">346</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,347" id="srcline347">347</a></span><span class="line"><span class="comment">% ----- CALCULATE BATTERY VOLTAGE ----------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,348" id="srcline348">348</a></span><span class="line"><span class="comment">% define all possible batEng values - convert them into SOCs</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,349" id="srcline349">349</a></span><span class="line"><span class="var type0" id="S105T0U1163">batSoc</span> = (<span class="var type0" id="S11T0U1169">tst_scalar_struct</span>.batEngMin : <span class="var type0" id="S11T0U1172">tst_scalar_struct</span>.batEngStp : <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,350" id="srcline350">350</a></span><span class="line">            <span class="var type0" id="S11T0U1175">tst_scalar_struct</span>.batEngMax) / <span class="var type0" id="S11T0U1178">tst_scalar_struct</span>.batEngMax;</span></span>
<span class="srcline"><span class="lineno"><a href="1,351" id="srcline351">351</a></span><span class="line"><span class="comment">% interpolate voltage value for each SOC </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,352" id="srcline352">352</a></span><span class="line"><span class="comment">%   discretization level: # of possible batEng steps</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,353" id="srcline353">353</a></span><span class="line"><span class="var type0" id="S106T0U1182">batOcv</span> = interp1(<span class="var type0" id="S14T0U1187">fzg_array_struct</span>.SOC_vs_OCV(:,1), <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,354" id="srcline354">354</a></span><span class="line">                 <span class="var type0" id="S14T0U1193">fzg_array_struct</span>.SOC_vs_OCV(:,2), <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,355" id="srcline355">355</a></span><span class="line">                 <span class="var type0" id="S105T0U1197">batSoc</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,356" id="srcline356">356</a></span><span class="line"><span class="comment">% -----------------------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,357" id="srcline357">357</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,358" id="srcline358">358</a></span><span class="line"><span class="comment">% ----- DEFINE batRst ---------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,359" id="srcline359">359</a></span><span class="line"><span class="comment">% usually, resistance is based on batPwr. Since batPwr is unkown, will be</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,360" id="srcline360">360</a></span><span class="line"><span class="comment">% using emoPwr as a benchmark instead</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,361" id="srcline361">361</a></span><span class="line"><span class="comment">%   b/c batPwr-batPwrLoss=emoPwr, both batPwr and emoPwr will generally</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,362" id="srcline362">362</a></span><span class="line"><span class="comment">%   have the same sign, unless batPwr&lt;batPwrLoss (which seems unlikely?)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,363" id="srcline363">363</a></span><span class="line"><span class="comment">%       may need to check this assumption later</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,364" id="srcline364">364</a></span><span class="line"><span class="var type0" id="S107T0U1200">batRstMax</span> = zeros(length(<span class="var type0" id="S100T0U1205">emoPwrMaxPosMat</span>), <span class="var type0" id="S34T0U1206">geaStaNum</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,365" id="srcline365">365</a></span><span class="line"><span class="var type0" id="S108T0U1209">batRstMin</span> = zeros(length(<span class="var type0" id="S99T0U1214">emoPwrMinPosMat</span>), <span class="var type0" id="S34T0U1215">geaStaNum</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,366" id="srcline366">366</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,367" id="srcline367">367</a></span><span class="line"><span class="comment">% the code below is performing this code snippet across the vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,368" id="srcline368">368</a></span><span class="line"><span class="comment">% if batPwr &lt; 0</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,369" id="srcline369">369</a></span><span class="line"><span class="comment">%     batRst = fzg_scalar_struct.batRstDch;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,370" id="srcline370">370</a></span><span class="line"><span class="comment">% else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,371" id="srcline371">371</a></span><span class="line"><span class="comment">%     batRst = fzg_scalar_struct.batRstChr;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,372" id="srcline372">372</a></span><span class="line"><span class="comment">% end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,373" id="srcline373">373</a></span><span class="line"><span class="var type0" id="S107T0U1219">batRstMax</span>(<span class="var type0" id="S100T0U1221">emoPwrMaxPosMat</span>&lt;0)    = <span class="var type0" id="S12T0U1224">fzg_scalar_struct</span>.batRstDch;</span></span>
<span class="srcline"><span class="lineno"><a href="1,374" id="srcline374">374</a></span><span class="line"><span class="var type0" id="S107T0U1229">batRstMax</span>(<span class="var type0" id="S100T0U1231">emoPwrMaxPosMat</span>&gt;=0)   = <span class="var type0" id="S12T0U1234">fzg_scalar_struct</span>.batRstChr;</span></span>
<span class="srcline"><span class="lineno"><a href="1,375" id="srcline375">375</a></span><span class="line"><span class="var type0" id="S108T0U1239">batRstMin</span>(<span class="var type0" id="S99T0U1241">emoPwrMinPosMat</span>&lt;0)    = <span class="var type0" id="S12T0U1244">fzg_scalar_struct</span>.batRstDch;</span></span>
<span class="srcline"><span class="lineno"><a href="1,376" id="srcline376">376</a></span><span class="line"><span class="var type0" id="S108T0U1249">batRstMin</span>(<span class="var type0" id="S99T0U1251">emoPwrMinPosMat</span>&gt;=0)   = <span class="var type0" id="S12T0U1254">fzg_scalar_struct</span>.batRstChr;</span></span>
<span class="srcline"><span class="lineno"><a href="1,377" id="srcline377">377</a></span><span class="line"><span class="comment">% -----------------------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,378" id="srcline378">378</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,379" id="srcline379">379</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,380" id="srcline380">380</a></span><span class="line"><span class="comment">% ----- CALCULATE batPwrLoss AND batPwr ---------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,381" id="srcline381">381</a></span><span class="line"><span class="comment">% % preallocate matrix with dims (timNim x (# of bat steps) x geaStaNum)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,382" id="srcline382">382</a></span><span class="line"><span class="comment">% batPwrMinLossTn3 = zeros(length(batRstMin), length(batOcv), geaStaNum);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,383" id="srcline383">383</a></span><span class="line"><span class="comment">% batPwrMaxLossTn3 = zeros(length(batRstMax), length(batOcv), geaStaNum);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,384" id="srcline384">384</a></span><span class="line"><span class="var type0" id="S109T0U1258">batPwrMinTn3</span>     = zeros(length(<span class="var type0" id="S108T0U1263">batRstMin</span>), length(<span class="var type0" id="S106T0U1266">batOcv</span>), <span class="var type0" id="S34T0U1267">geaStaNum</span>); </span></span>
<span class="srcline"><span class="lineno"><a href="1,385" id="srcline385">385</a></span><span class="line"><span class="var type0" id="S110T0U1270">batPwrMaxTn3</span>     = zeros(length(<span class="var type0" id="S107T0U1275">batRstMax</span>), length(<span class="var type0" id="S106T0U1278">batOcv</span>), <span class="var type0" id="S34T0U1279">geaStaNum</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,386" id="srcline386">386</a></span><span class="line"><span class="var type0" id="S111T0U1282">batPwrDemTn3</span>     = zeros(<span class="var type0" id="S49T0U1285">timNum</span>,            length(<span class="var type0" id="S106T0U1288">batOcv</span>), <span class="var type0" id="S34T0U1289">geaStaNum</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,387" id="srcline387">387</a></span><span class="line"><span class="comment">% NOTE: this preprocessing is a bit slow because of lack of vectorization.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,388" id="srcline388">388</a></span><span class="line"><span class="comment">% may be able to speed up later, but since it is in preprocessing, it is</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,389" id="srcline389">389</a></span><span class="line"><span class="comment">% low priority at the moment</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,390" id="srcline390">390</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,391" id="srcline391">391</a></span><span class="line"><span class="comment">% run battery power limitations for the entire speed profile timelength</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,392" id="srcline392">392</a></span><span class="line"><span class="keyword">for</span> <span class="var type0" id="S112T0U1292">tim</span> = 1 : <span class="var type0" id="S49T0U1295">timNum</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,393" id="srcline393">393</a></span><span class="line">    <span class="comment">% bat index is for varying battery voltage levels</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,394" id="srcline394">394</a></span><span class="line">    <span class="keyword">for</span> <span class="var type0" id="S113T0U1298">bat</span> = 1 : length(<span class="var type0" id="S106T0U1303">batOcv</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,395" id="srcline395">395</a></span><span class="line">        <span class="comment">% gear is for looping through diff resistance and emoPwr bound values</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,396" id="srcline396">396</a></span><span class="line">        <span class="keyword">for</span> <span class="var type0" id="S101T0U1306">gea</span> = 1 : <span class="var type0" id="S34T0U1309">geaStaNum</span> </span></span>
<span class="srcline"><span class="lineno"><a href="1,397" id="srcline397">397</a></span><span class="line">            <span class="comment">% internal battery power losses: quadratic equation derived from</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,398" id="srcline398">398</a></span><span class="line">            <span class="comment">%   batPwrLoss = I^2*batRst,</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,399" id="srcline399">399</a></span><span class="line">            <span class="comment">%   batPwr     = V*I, and</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,400" id="srcline400">400</a></span><span class="line">            <span class="comment">%   batPwr - batPwrLoss = emoPwr (where emoPwr is given).</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,401" id="srcline401">401</a></span><span class="line">            <span class="comment">%   </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,402" id="srcline402">402</a></span><span class="line">            <span class="comment">% batPwrMin/MaxLossMat calculated in two combined steps:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,403" id="srcline403">403</a></span><span class="line">            <span class="comment">%   1. substituting batPwr and batPwrLoss into 3rd equation and solving</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,404" id="srcline404">404</a></span><span class="line">            <span class="comment">%       for current I.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,405" id="srcline405">405</a></span><span class="line">            <span class="comment">%   2. plugging the found current I back into the batPwrLoss eq and</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,406" id="srcline406">406</a></span><span class="line">            <span class="comment">%       solving for batPwrLoss (batRst was already preprocessed above).</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,407" id="srcline407">407</a></span><span class="line">            <span class="var type0" id="S114T0U1312">batPwrMinLoss</span> = ((<span class="var type0" id="S106T0U1319">batOcv</span>(<span class="var type0" id="S113T0U1320">bat</span>)-sqrt(<span class="var type0" id="S106T0U1326">batOcv</span>(<span class="var type0" id="S113T0U1327">bat</span>).^2 - 4*<span class="var type0" id="S108T0U1333">batRstMin</span>(<span class="var type0" id="S112T0U1334">tim</span>, <span class="var type0" id="S101T0U1335">gea</span>) * <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,408" id="srcline408">408</a></span><span class="line">                                        <span class="var type0" id="S99T0U1337">emoPwrMinPosMat</span>(<span class="var type0" id="S112T0U1338">tim</span>,<span class="var type0" id="S101T0U1339">gea</span>))).^2) / <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,409" id="srcline409">409</a></span><span class="line">                                        (4*<span class="var type0" id="S108T0U1345">batRstMin</span>(<span class="var type0" id="S112T0U1346">tim</span>, <span class="var type0" id="S101T0U1347">gea</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,410" id="srcline410">410</a></span><span class="line">            <span class="var type0" id="S116T0U1350">batPwrMaxLoss</span> = ((<span class="var type0" id="S106T0U1357">batOcv</span>(<span class="var type0" id="S113T0U1358">bat</span>)-sqrt(<span class="var type0" id="S106T0U1364">batOcv</span>(<span class="var type0" id="S113T0U1365">bat</span>).^2 - 4*<span class="var type0" id="S107T0U1371">batRstMax</span>(<span class="var type0" id="S112T0U1372">tim</span>, <span class="var type0" id="S101T0U1373">gea</span>) * <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,411" id="srcline411">411</a></span><span class="line">                                        <span class="var type0" id="S100T0U1375">emoPwrMaxPosMat</span>(<span class="var type0" id="S112T0U1376">tim</span>,<span class="var type0" id="S101T0U1377">gea</span>))).^2) / <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,412" id="srcline412">412</a></span><span class="line">                                        (4*<span class="var type0" id="S107T0U1383">batRstMax</span>(<span class="var type0" id="S112T0U1384">tim</span>, <span class="var type0" id="S101T0U1385">gea</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,413" id="srcline413">413</a></span><span class="line">                                    </span></span>
<span class="srcline"><span class="lineno"><a href="1,414" id="srcline414">414</a></span><span class="line">            <span class="var type0" id="S117T0U1388">batPwrDemLoss</span> = ((<span class="var type0" id="S106T0U1395">batOcv</span>(<span class="var type0" id="S113T0U1396">bat</span>)-sqrt(<span class="var type0" id="S106T0U1402">batOcv</span>(<span class="var type0" id="S113T0U1403">bat</span>).^2 - 4*<span class="var type0" id="S107T0U1409">batRstMax</span>(<span class="var type0" id="S112T0U1410">tim</span>, <span class="var type0" id="S101T0U1411">gea</span>) * <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,415" id="srcline415">415</a></span><span class="line">                                        <span class="var type0" id="S104T0U1413">crsPwrMat</span>(<span class="var type0" id="S112T0U1414">tim</span>,<span class="var type0" id="S101T0U1415">gea</span>))).^2) / <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,416" id="srcline416">416</a></span><span class="line">                                        (4*<span class="var type0" id="S107T0U1421">batRstMax</span>(<span class="var type0" id="S112T0U1422">tim</span>, <span class="var type0" id="S101T0U1423">gea</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,417" id="srcline417">417</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,418" id="srcline418">418</a></span><span class="line">            <span class="comment">% calculate boundaries that battery can (dis)charge at</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,419" id="srcline419">419</a></span><span class="line">            <span class="comment">%   in other words, calculate all possible batPwr values across emoSpd</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,420" id="srcline420">420</a></span><span class="line">            <span class="comment">%   indexes for EQUATION:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,421" id="srcline421">421</a></span><span class="line">            <span class="comment">%       batPwr = emoPwr + batPwrLoss</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,422" id="srcline422">422</a></span><span class="line">            <span class="var type0" id="S109T0U1427">batPwrMinTn3</span>(<span class="var type0" id="S112T0U1428">tim</span>, <span class="var type0" id="S113T0U1429">bat</span>, <span class="var type0" id="S101T0U1430">gea</span>)   = <span class="var type0" id="S114T0U1432">batPwrMinLoss</span> + <span class="var type0" id="S99T0U1434">emoPwrMinPosMat</span>(<span class="var type0" id="S112T0U1435">tim</span>, <span class="var type0" id="S101T0U1436">gea</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,423" id="srcline423">423</a></span><span class="line">            <span class="var type0" id="S110T0U1440">batPwrMaxTn3</span>(<span class="var type0" id="S112T0U1441">tim</span>, <span class="var type0" id="S113T0U1442">bat</span>, <span class="var type0" id="S101T0U1443">gea</span>)   = <span class="var type0" id="S116T0U1445">batPwrMaxLoss</span> + <span class="var type0" id="S100T0U1447">emoPwrMaxPosMat</span>(<span class="var type0" id="S112T0U1448">tim</span>, <span class="var type0" id="S101T0U1449">gea</span>);  </span></span>
<span class="srcline"><span class="lineno"><a href="1,424" id="srcline424">424</a></span><span class="line">            <span class="var type0" id="S111T0U1453">batPwrDemTn3</span>(<span class="var type0" id="S112T0U1454">tim</span>, <span class="var type0" id="S113T0U1455">bat</span>, <span class="var type0" id="S101T0U1456">gea</span>)   = <span class="var type0" id="S117T0U1458">batPwrDemLoss</span> + <span class="var type0" id="S104T0U1460">crsPwrMat</span>(<span class="var type0" id="S112T0U1461">tim</span>, <span class="var type0" id="S101T0U1462">gea</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,425" id="srcline425">425</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,426" id="srcline426">426</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,427" id="srcline427">427</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,428" id="srcline428">428</a></span><span class="line"><span class="comment">% -----------------------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,429" id="srcline429">429</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,430" id="srcline430">430</a></span><span class="line"><span class="comment">% ----- DISCRETIZE batPwrMin/Mat's --------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,431" id="srcline431">431</a></span><span class="line"><span class="comment">% discretize the batPwrMin/Mat matrices to the batEngStp value</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,432" id="srcline432">432</a></span><span class="line"><span class="var type0" id="S118T0U1465">batPwrStp</span> = <span class="var type0" id="S11T0U1468">tst_scalar_struct</span>.batEngStp / <span class="var type0" id="S19T0U1470">timStp</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,433" id="srcline433">433</a></span><span class="line"><span class="var type0" id="S119T0U1473">batPwrMaxIdxTn3</span> = floor(<span class="var type0" id="S110T0U1477">batPwrMaxTn3</span> ./ <span class="var type0" id="S118T0U1478">batPwrStp</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,434" id="srcline434">434</a></span><span class="line"><span class="var type0" id="S120T0U1481">batPwrMinIdxTn3</span> = ceil(<span class="var type0" id="S109T0U1485">batPwrMinTn3</span> ./ <span class="var type0" id="S118T0U1486">batPwrStp</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,435" id="srcline435">435</a></span><span class="line"><span class="var type0" id="S121T0U1489">batPwrDemIdxTn3</span> = ceil(<span class="var type0" id="S111T0U1493">batPwrDemTn3</span> ./ <span class="var type0" id="S118T0U1494">batPwrStp</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,436" id="srcline436">436</a></span><span class="line"><span class="comment">% -----------------------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,437" id="srcline437">437</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,438" id="srcline438">438</a></span><span class="line"><span class="comment">%% define vector for possibilities of engine state on-off values</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,439" id="srcline439">439</a></span><span class="line"><span class="comment">%   2 = can toggle (two states, on-of)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,440" id="srcline440">440</a></span><span class="line"><span class="comment">%   1 = cannot toggle, must stay in current state for idx (most likely off)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,441" id="srcline441">441</a></span><span class="line"><span class="var type0" id="S122T0U1497">engStaVec_timInx</span> = ones(<span class="var type0" id="S29T0U1501">timInxEnd</span>, 1)*2;</span></span>
<span class="srcline"><span class="lineno"><a href="1,442" id="srcline442">442</a></span><span class="line"><span class="var type0" id="S122T0U1507">engStaVec_timInx</span>(<span class="var type0" id="S28T0U1508">timInxBeg</span>) = <span class="var type0" id="S25T0U1510">engBeg</span>+1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,443" id="srcline443">443</a></span><span class="line"><span class="var type0" id="S122T0U1515">engStaVec_timInx</span>(<span class="var type0" id="S29T0U1516">timInxEnd</span>) = <span class="var type0" id="S26T0U1518">engEnd</span>+1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,444" id="srcline444">444</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,445" id="srcline445">445</a></span><span class="line"><span class="comment">%% define battery looping vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,446" id="srcline446">446</a></span><span class="line"><span class="comment">% make sure that the max/min electric power values are discretized right</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,447" id="srcline447">447</a></span><span class="line"><span class="keyword">if</span> mod(<span class="var type0" id="S12T0U1525">fzg_scalar_struct</span>.batPwrMax, <span class="var type0" id="S11T0U1528">tst_scalar_struct</span>.batEngStp)</span></span>
<span class="srcline"><span class="lineno"><a href="1,448" id="srcline448">448</a></span><span class="line">    fprintf(<span class="string">'Note: E'' limits weren''t discretized to E'' step size.\n'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,449" id="srcline449">449</a></span><span class="line">    fprintf(<span class="string">'   Old max E'': %i\n'</span>,   <span class="var type0" id="S12T0U1539">fzg_scalar_struct</span>.batPwrMax);</span></span>
<span class="srcline"><span class="lineno"><a href="1,450" id="srcline450">450</a></span><span class="line">    fprintf(<span class="string">'   Old min E'': %i\n'</span>,   <span class="var type0" id="S12T0U1546">fzg_scalar_struct</span>.batPwrMin);</span></span>
<span class="srcline"><span class="lineno"><a href="1,451" id="srcline451">451</a></span><span class="line">    <span class="var type0" id="S12T0U1551">fzg_scalar_struct</span>.batPwrMax=floor(<span class="var type0" id="S12T0U1558">fzg_scalar_struct</span>.batPwrMax / <span class="var type0" id="S11T0U1561">tst_scalar_struct</span>.batEngStp)<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,452" id="srcline452">452</a></span><span class="line">                                    * <span class="var type0" id="S11T0U1564">tst_scalar_struct</span>.batEngStp;</span></span>
<span class="srcline"><span class="lineno"><a href="1,453" id="srcline453">453</a></span><span class="line">    <span class="var type0" id="S12T0U1569">fzg_scalar_struct</span>.batPwrMin=ceil( <span class="var type0" id="S12T0U1576">fzg_scalar_struct</span>.batPwrMin / <span class="var type0" id="S11T0U1579">tst_scalar_struct</span>.batEngStp) <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,454" id="srcline454">454</a></span><span class="line">                                    * <span class="var type0" id="S11T0U1582">tst_scalar_struct</span>.batEngStp;</span></span>
<span class="srcline"><span class="lineno"><a href="1,455" id="srcline455">455</a></span><span class="line">    fprintf(<span class="string">'   New max E'': %i\n'</span>,   <span class="var type0" id="S12T0U1589">fzg_scalar_struct</span>.batPwrMax);</span></span>
<span class="srcline"><span class="lineno"><a href="1,456" id="srcline456">456</a></span><span class="line">    fprintf(<span class="string">'   New min E'': %i\n'</span>,   <span class="var type0" id="S12T0U1596">fzg_scalar_struct</span>.batPwrMin);</span></span>
<span class="srcline"><span class="lineno"><a href="1,457" id="srcline457">457</a></span><span class="line">    fprintf(<span class="string">'   E'' step size used: %i\n'</span>, <span class="var type0" id="S11T0U1603">tst_scalar_struct</span>.batEngStp);</span></span>
<span class="srcline"><span class="lineno"><a href="1,458" id="srcline458">458</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,459" id="srcline459">459</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,460" id="srcline460">460</a></span><span class="line"><span class="comment">%% Calculating optimal predecessors with DP</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,461" id="srcline461">461</a></span><span class="line"><span class="comment">% two functions: one finding optimal gear state and one with input gea vals</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,462" id="srcline462">462</a></span><span class="line">fprintf(<span class="string">'-Initializing model<span class="keyword">...</span>\n'</span>); </span></span>
<span class="srcline"><span class="lineno"><a href="1,463" id="srcline463">463</a></span><span class="line"><span class="comment">% tic</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,464" id="srcline464">464</a></span><span class="line"><span class="comment">% if tst_scalar_struct.useGeaSta</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,465" id="srcline465">465</a></span><span class="line">        [               <span class="keyword">...</span><span class="comment"> --- Ausgangsgrößen:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,466" id="srcline466">466</a></span><span class="line">        <span class="var type0" id="S125T0U1612">optPreInxTn4</span>,   <span class="keyword">...</span><span class="comment">  Tensor 4. Stufe für opt. Vorgängerkoordinaten</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,467" id="srcline467">467</a></span><span class="line">        <span class="var type0" id="S126T0U1613">batPwrOptTn4</span>,   <span class="keyword">...</span><span class="comment">  Tensor 4. Stufe der Batteriekraft</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,468" id="srcline468">468</a></span><span class="line">        <span class="var type0" id="S127T0U1614">fulEngOptTn4</span>,   <span class="keyword">...</span><span class="comment">  Tensor 4. Stufe für die Kraftstoffenergie </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,469" id="srcline469">469</a></span><span class="line">        <span class="var type0" id="S128T0U1615">cos2goActTn3</span>    <span class="keyword">...</span><span class="comment">  Tensor 4. der optimalen Kosten der Hamiltonfunktion </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,470" id="srcline470">470</a></span><span class="line">        ] =             <span class="keyword">...</span><span class="comment"> </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,471" id="srcline471">471</a></span><span class="line">        clcDP_focus_mex     <span class="keyword">...</span><span class="comment"> FUNKTION</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,472" id="srcline472">472</a></span><span class="line">        (               <span class="keyword">...</span><span class="comment"> --- Eingangsgrößen:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,473" id="srcline473">473</a></span><span class="line">        <span class="var type0" id="S15T0U1618">disFlg</span>,         <span class="keyword">...</span><span class="comment"> Skalar - Flag für Ausgabe in das Commandwindow</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,474" id="srcline474">474</a></span><span class="line">        <span class="var type0" id="S16T0U1619">iceFlgBool</span>,     <span class="keyword">...</span><span class="comment"> skalar - is engine toggle on/off allowed?</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,475" id="srcline475">475</a></span><span class="line">        <span class="var type0" id="S17T0U1620">brkBool</span>,        <span class="keyword">...</span><span class="comment"> skalar - allow states requireing braking?</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,476" id="srcline476">476</a></span><span class="line">        <span class="var type0" id="S19T0U1621">timStp</span>,         <span class="keyword">...</span><span class="comment"> Skalar für die Wegschrittweite in m</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,477" id="srcline477">477</a></span><span class="line">        <span class="var type0" id="S62T0U1622">batEngBeg</span>,      <span class="keyword">...</span><span class="comment"> Skalar für die Batterieenergie am Beginn in Ws</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,478" id="srcline478">478</a></span><span class="line">        <span class="var type0" id="S24T0U1623">batPwrAux</span>,      <span class="keyword">...</span><span class="comment"> Skalar für die Nebenverbrauchlast in W</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,479" id="srcline479">479</a></span><span class="line">        <span class="var type0" id="S27T0U1624">staChgPenCosVal</span>,<span class="keyword">...</span><span class="comment"> Skalar für die Strafkosten beim Zustandswechsel</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,480" id="srcline480">480</a></span><span class="line">        <span class="var type0" id="S28T0U1625">timInxBeg</span>,      <span class="keyword">...</span><span class="comment"> Skalar für Anfangsindex in den Eingangsdaten</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,481" id="srcline481">481</a></span><span class="line">        <span class="var type0" id="S29T0U1626">timInxEnd</span>,      <span class="keyword">...</span><span class="comment"> Skalar für Endindex in den Eingangsdaten</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,482" id="srcline482">482</a></span><span class="line">        <span class="var type0" id="S49T0U1627">timNum</span>,         <span class="keyword">...</span><span class="comment"> Skalar für die max. Anzahl an Wegstï¿½tzstellen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,483" id="srcline483">483</a></span><span class="line">        <span class="var type0" id="S25T0U1628">engBeg</span>,         <span class="keyword">...</span><span class="comment"> scalar - beginnnig engine state</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,484" id="srcline484">484</a></span><span class="line">        <span class="var type0" id="S122T0U1629">engStaVec_timInx</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,485" id="srcline485">485</a></span><span class="line">        <span class="var type0" id="S30T0U1630">staBeg</span>,         <span class="keyword">...</span><span class="comment"> Skalar für den Startzustand des Antriebsstrangs</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,486" id="srcline486">486</a></span><span class="line">        <span class="var type0" id="S106T0U1631">batOcv</span>,         <span class="keyword">...</span><span class="comment"> battery voltage vector w/ value for each SOC</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,487" id="srcline487">487</a></span><span class="line">        <span class="var type0" id="S46T0U1632">velVec</span>,         <span class="keyword">...</span><span class="comment"> velocity vector contiaing input speed profile</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,488" id="srcline488">488</a></span><span class="line">        <span class="var type0" id="S91T0U1633">crsSpdMat</span>,      <span class="keyword">...</span><span class="comment"> crankshaft speed demand for each gear</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,489" id="srcline489">489</a></span><span class="line">        <span class="var type0" id="S93T0U1634">crsTrqMat</span>,      <span class="keyword">...</span><span class="comment"> crankshaft torque demand for each gear</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,490" id="srcline490">490</a></span><span class="line">        <span class="var type0" id="S98T0U1635">emoTrqMinPosMat</span>,<span class="keyword">...</span><span class="comment"> min emoTrq along speed profile for each gear</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,491" id="srcline491">491</a></span><span class="line">        <span class="var type0" id="S97T0U1636">emoTrqMaxPosMat</span>,<span class="keyword">...</span><span class="comment"> max emoTrq along speed profile for each gear</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,492" id="srcline492">492</a></span><span class="line">        <span class="var type0" id="S99T0U1637">emoPwrMinPosMat</span>,<span class="keyword">...</span><span class="comment"> min emoPwr along speed profile for each gear</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,493" id="srcline493">493</a></span><span class="line">        <span class="var type0" id="S100T0U1638">emoPwrMaxPosMat</span>,<span class="keyword">...</span><span class="comment"> max emoPwr along speed profile for each gear</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,494" id="srcline494">494</a></span><span class="line">        <span class="var type0" id="S96T0U1639">iceTrqMinPosMat</span>,<span class="keyword">...</span><span class="comment"> min iceTrq along speed profile for each gear</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,495" id="srcline495">495</a></span><span class="line">        <span class="var type0" id="S95T0U1640">iceTrqMaxPosMat</span>,<span class="keyword">...</span><span class="comment"> max iceTrq along speed profile for each gear</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,496" id="srcline496">496</a></span><span class="line">        <span class="var type0" id="S120T0U1641">batPwrMinIdxTn3</span>,<span class="keyword">...</span><span class="comment"> min indexes/steps that bat can change</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,497" id="srcline497">497</a></span><span class="line">        <span class="var type0" id="S119T0U1642">batPwrMaxIdxTn3</span>,<span class="keyword">...</span><span class="comment"> max indexes/steps that bat can change</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,498" id="srcline498">498</a></span><span class="line">        <span class="var type0" id="S121T0U1643">batPwrDemIdxTn3</span>,<span class="keyword">...</span><span class="comment"> power demand by bat if only EM is running</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,499" id="srcline499">499</a></span><span class="line">        <span class="var type0" id="S11T0U1644">tst_scalar_struct</span>,     <span class="keyword">...</span><span class="comment"> struct w/ tst data state var params</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,500" id="srcline500">500</a></span><span class="line">        <span class="var type0" id="S12T0U1645">fzg_scalar_struct</span>,     <span class="keyword">...</span><span class="comment"> struct der Fahrzeugparameter - NUR SKALARS</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,501" id="srcline501">501</a></span><span class="line">        <span class="var type0" id="S14T0U1646">fzg_array_struct</span>       <span class="keyword">...</span><span class="comment"> struct der Fahrzeugparameter - NUR ARRAYS</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,502" id="srcline502">502</a></span><span class="line">        );</span></span>
<span class="srcline"><span class="lineno"><a href="1,503" id="srcline503">503</a></span><span class="line"><span class="comment">%     </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,504" id="srcline504">504</a></span><span class="line"><span class="comment">%     profile on -history</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,505" id="srcline505">505</a></span><span class="line"><span class="comment">%         [               <span class="keyword">...</span><span class="comment"> --- Ausgangsgrößen:</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,506" id="srcline506">506</a></span><span class="line"><span class="comment">%         optPreInxTn4,   <span class="keyword">...</span><span class="comment">  Tensor 4. Stufe für opt. Vorgängerkoordinaten</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,507" id="srcline507">507</a></span><span class="line"><span class="comment">%         batPwrOptTn4,   <span class="keyword">...</span><span class="comment">  Tensor 4. Stufe der Batteriekraft</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,508" id="srcline508">508</a></span><span class="line"><span class="comment">%         fulEngOptTn4,   <span class="keyword">...</span><span class="comment">  Tensor 4. Stufe für die Kraftstoffenergie </span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,509" id="srcline509">509</a></span><span class="line"><span class="comment">%         cos2goActTn3    <span class="keyword">...</span><span class="comment">  Tensor 4. der optimalen Kosten der Hamiltonfunktion </span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,510" id="srcline510">510</a></span><span class="line"><span class="comment">%         ] =             <span class="keyword">...</span><span class="comment"> </span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,511" id="srcline511">511</a></span><span class="line"><span class="comment">%         clcDP_focus_mex <span class="keyword">...</span><span class="comment"> FUNKTION</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,512" id="srcline512">512</a></span><span class="line"><span class="comment">%         (               <span class="keyword">...</span><span class="comment"> --- Eingangsgrößen:</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,513" id="srcline513">513</a></span><span class="line"><span class="comment">%         disFlg,         <span class="keyword">...</span><span class="comment"> Skalar - Flag fï¿½r Ausgabe in das Commandwindow</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,514" id="srcline514">514</a></span><span class="line"><span class="comment">%         iceFlgBool,     <span class="keyword">...</span><span class="comment"> skalar - is engine toggle on/off allowed?</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,515" id="srcline515">515</a></span><span class="line"><span class="comment">%         brkBool,        <span class="keyword">...</span><span class="comment"> skalar - allow states requireing braking?</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,516" id="srcline516">516</a></span><span class="line"><span class="comment">%         timStp,         <span class="keyword">...</span><span class="comment"> Skalar fï¿½r die Wegschrittweite in m</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,517" id="srcline517">517</a></span><span class="line"><span class="comment">%         batEngBeg,      <span class="keyword">...</span><span class="comment"> Skalar fï¿½r die Batterieenergie am Beginn in Ws</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,518" id="srcline518">518</a></span><span class="line"><span class="comment">%         batPwrAux,      <span class="keyword">...</span><span class="comment"> Skalar fï¿½r die Nebenverbrauchlast in W</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,519" id="srcline519">519</a></span><span class="line"><span class="comment">%         staChgPenCosVal,<span class="keyword">...</span><span class="comment"> Skalar fï¿½r die Strafkosten beim Zustandswechsel</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,520" id="srcline520">520</a></span><span class="line"><span class="comment">%         timInxBeg,      <span class="keyword">...</span><span class="comment"> Skalar fï¿½r Anfangsindex in den Eingangsdaten</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,521" id="srcline521">521</a></span><span class="line"><span class="comment">%         timInxEnd,      <span class="keyword">...</span><span class="comment"> Skalar fï¿½r Endindex in den Eingangsdaten</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,522" id="srcline522">522</a></span><span class="line"><span class="comment">%         timNum,         <span class="keyword">...</span><span class="comment"> Skalar fï¿½r die max. Anzahl an Wegstï¿½tzstellen</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,523" id="srcline523">523</a></span><span class="line"><span class="comment">%         engBeg,         <span class="keyword">...</span><span class="comment"> scalar - beginnnig engine state</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,524" id="srcline524">524</a></span><span class="line"><span class="comment">%         engStaVec_timInx,<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,525" id="srcline525">525</a></span><span class="line"><span class="comment">%         staBeg,         <span class="keyword">...</span><span class="comment"> Skalar fï¿½r den Startzustand des Antriebsstrangs</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,526" id="srcline526">526</a></span><span class="line"><span class="comment">%         batOcv,         <span class="keyword">...</span><span class="comment"> battery voltage vector w/ value for each SOC</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,527" id="srcline527">527</a></span><span class="line"><span class="comment">%         velVec,         <span class="keyword">...</span><span class="comment"> velocity vector contiaing input speed profile</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,528" id="srcline528">528</a></span><span class="line"><span class="comment">%         crsSpdMat,      <span class="keyword">...</span><span class="comment"> crankshaft speed demand for each gear</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,529" id="srcline529">529</a></span><span class="line"><span class="comment">%         crsTrqMat,      <span class="keyword">...</span><span class="comment"> crankshaft torque demand for each gear</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,530" id="srcline530">530</a></span><span class="line"><span class="comment">%         emoTrqMinPosMat,<span class="keyword">...</span><span class="comment"> min emoTrq along speed profile for each gear</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,531" id="srcline531">531</a></span><span class="line"><span class="comment">%         emoTrqMaxPosMat,<span class="keyword">...</span><span class="comment"> max emoTrq along speed profile for each gear</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,532" id="srcline532">532</a></span><span class="line"><span class="comment">%         emoPwrMinPosMat,<span class="keyword">...</span><span class="comment"> min emoPwr along speed profile for each gear</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,533" id="srcline533">533</a></span><span class="line"><span class="comment">%         emoPwrMaxPosMat,<span class="keyword">...</span><span class="comment"> max emoPwr along speed profile for each gear</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,534" id="srcline534">534</a></span><span class="line"><span class="comment">%         iceTrqMinPosMat,<span class="keyword">...</span><span class="comment"> min iceTrq along speed profile for each gear</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,535" id="srcline535">535</a></span><span class="line"><span class="comment">%         iceTrqMaxPosMat,<span class="keyword">...</span><span class="comment"> max iceTrq along speed profile for each gear</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,536" id="srcline536">536</a></span><span class="line"><span class="comment">%         batPwrMinIdxTn3,<span class="keyword">...</span><span class="comment"> min indexes/steps that bat can change</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,537" id="srcline537">537</a></span><span class="line"><span class="comment">%         batPwrMaxIdxTn3,<span class="keyword">...</span><span class="comment"> max indexes/steps that bat can change</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,538" id="srcline538">538</a></span><span class="line"><span class="comment">%         batPwrDemIdxTn3,<span class="keyword">...</span><span class="comment"> power demand by bat if only EM is running</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,539" id="srcline539">539</a></span><span class="line"><span class="comment">%         tst_scalar_struct,     <span class="keyword">...</span><span class="comment"> struct w/ tst data state var params</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,540" id="srcline540">540</a></span><span class="line"><span class="comment">%         fzg_scalar_struct,     <span class="keyword">...</span><span class="comment"> struct der Fahrzeugparameter - NUR SKALARS</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,541" id="srcline541">541</a></span><span class="line"><span class="comment">%         fzg_array_struct       <span class="keyword">...</span><span class="comment"> struct der Fahrzeugparameter - NUR ARRAYS</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,542" id="srcline542">542</a></span><span class="line"><span class="comment">%         );</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,543" id="srcline543">543</a></span><span class="line"><span class="comment">%     toc</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,544" id="srcline544">544</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,545" id="srcline545">545</a></span><span class="line"><span class="comment">% else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,546" id="srcline546">546</a></span><span class="line"><span class="comment">%         % writiing up a gear changing model</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,547" id="srcline547">547</a></span><span class="line"><span class="comment">%         % develop random vector for switching gear</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,548" id="srcline548">548</a></span><span class="line"><span class="comment">%         randStp = round(rand(1181, 1));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,549" id="srcline549">549</a></span><span class="line"><span class="comment">%         randNeg = round(rand(1181, 1));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,550" id="srcline550">550</a></span><span class="line"><span class="comment">%         randStp = randStp - randNeg;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,551" id="srcline551">551</a></span><span class="line"><span class="comment">%         % preallocate and populate input geaVec</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,552" id="srcline552">552</a></span><span class="line"><span class="comment">%         staVec = zeros(length(randStp), 1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,553" id="srcline553">553</a></span><span class="line"><span class="comment">%         staVec(1) = staBeg;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,554" id="srcline554">554</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,555" id="srcline555">555</a></span><span class="line"><span class="comment">%         for i = 2 : length(randStp)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,556" id="srcline556">556</a></span><span class="line"><span class="comment">%                 staVec(i) = staVec(i-1) + randStp(i);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,557" id="srcline557">557</a></span><span class="line"><span class="comment">%                 % set boundaries</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,558" id="srcline558">558</a></span><span class="line"><span class="comment">%                 staVec(i) = max(tst_scalar_struct.geaStaMin, staVec(i));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,559" id="srcline559">559</a></span><span class="line"><span class="comment">%                 staVec(i) = min(tst_scalar_struct.geaStaMax, staVec(i));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,560" id="srcline560">560</a></span><span class="line"><span class="comment">%         end    </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,561" id="srcline561">561</a></span><span class="line"><span class="comment">%         % run input_gear_vector version of DP</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,562" id="srcline562">562</a></span><span class="line"><span class="comment">%         [               <span class="keyword">...</span><span class="comment"> --- Ausgangsgrï¿½ï¿½en:</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,563" id="srcline563">563</a></span><span class="line"><span class="comment">%         optPreInxTn3,   <span class="keyword">...</span><span class="comment">  Tensor 3. Stufe fï¿½r opt. Vorgï¿½ngerkoordinaten</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,564" id="srcline564">564</a></span><span class="line"><span class="comment">%         batFrcOptTn3,   <span class="keyword">...</span><span class="comment">  Tensor 3. Stufe der Batteriekraft</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,565" id="srcline565">565</a></span><span class="line"><span class="comment">%         fulEngOptTn3,   <span class="keyword">...</span><span class="comment">  Tensor 3. Stufe fï¿½r die Kraftstoffenergie </span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,566" id="srcline566">566</a></span><span class="line"><span class="comment">%         cos2goActMat    <span class="keyword">...</span><span class="comment">  Matrix der optimalen Kosten der Hamiltonfunktion </span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,567" id="srcline567">567</a></span><span class="line"><span class="comment">%         ] =             <span class="keyword">...</span><span class="comment"> </span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,568" id="srcline568">568</a></span><span class="line"><span class="comment">%         clcDP_focus_useGeaVec     <span class="keyword">...</span><span class="comment"> FUNKTION</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,569" id="srcline569">569</a></span><span class="line"><span class="comment">%         (               <span class="keyword">...</span><span class="comment"> --- Eingangsgrï¿½ï¿½en:</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,570" id="srcline570">570</a></span><span class="line"><span class="comment">%         disFlg,         <span class="keyword">...</span><span class="comment"> Skalar - Flag fï¿½r Ausgabe in das Commandwindow</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,571" id="srcline571">571</a></span><span class="line"><span class="comment">%         iceFlgBool,     <span class="keyword">...</span><span class="comment"> skalar - is engine toggle on/off allowed?</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,572" id="srcline572">572</a></span><span class="line"><span class="comment">%         timStp,        <span class="keyword">...</span><span class="comment"> Skalar fï¿½r die Wegschrittweite in m</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,573" id="srcline573">573</a></span><span class="line"><span class="comment">%         batEngBeg,      <span class="keyword">...</span><span class="comment"> Skalar fï¿½r die Batterieenergie am Beginn in Ws</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,574" id="srcline574">574</a></span><span class="line"><span class="comment">%         batPwrAux,      <span class="keyword">...</span><span class="comment"> Skalar fï¿½r die Nebenverbrauchlast in W</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,575" id="srcline575">575</a></span><span class="line"><span class="comment">%         staChgPenCosVal,<span class="keyword">...</span><span class="comment"> Skalar fï¿½r die Strafkosten beim Zustandswechsel</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,576" id="srcline576">576</a></span><span class="line"><span class="comment">%         timInxBeg,      <span class="keyword">...</span><span class="comment"> Skalar fï¿½r Anfangsindex in den Eingangsdaten</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,577" id="srcline577">577</a></span><span class="line"><span class="comment">%         timInxEnd,      <span class="keyword">...</span><span class="comment"> Skalar fï¿½r Endindex in den Eingangsdaten</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,578" id="srcline578">578</a></span><span class="line"><span class="comment">%         timNum,        <span class="keyword">...</span><span class="comment"> Skalar fï¿½r die max. Anzahl an Wegstï¿½tzstellen</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,579" id="srcline579">579</a></span><span class="line"><span class="comment">%         engBeg,         <span class="keyword">...</span><span class="comment"> scalar - beginnnig engine state</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,580" id="srcline580">580</a></span><span class="line"><span class="comment">%         engStaVec_timInx,<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,581" id="srcline581">581</a></span><span class="line"><span class="comment">%         <span class="keyword">...</span><span class="comment">staBeg,         ... Skalar fï¿½r den Startzustand des Antriebsstrangs</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,582" id="srcline582">582</a></span><span class="line"><span class="comment">%         staVec,         <span class="keyword">...</span><span class="comment"> input gear vector</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,583" id="srcline583">583</a></span><span class="line"><span class="comment">%         velVec,         <span class="keyword">...</span><span class="comment"> velocity vector contiaing input speed profile</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,584" id="srcline584">584</a></span><span class="line"><span class="comment">%         whlTrq,         <span class="keyword">...</span><span class="comment"> wheel torque demand vector for the speed profile</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,585" id="srcline585">585</a></span><span class="line"><span class="comment">%         tst_scalar_struct,     <span class="keyword">...</span><span class="comment"> struct w/ tst data state var params</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,586" id="srcline586">586</a></span><span class="line"><span class="comment">%         fzg_scalar_struct,     <span class="keyword">...</span><span class="comment"> struct der Fahrzeugparameter - NUR SKALARS</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,587" id="srcline587">587</a></span><span class="line"><span class="comment">%         fzg_array_struct       <span class="keyword">...</span><span class="comment"> struct der Fahrzeugparameter - NUR ARRAYS</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,588" id="srcline588">588</a></span><span class="line"><span class="comment">%         );</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,589" id="srcline589">589</a></span><span class="line"><span class="comment">% </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,590" id="srcline590">590</a></span><span class="line"><span class="comment">% end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,591" id="srcline591">591</a></span><span class="line"><span class="comment">%% end conditions </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,592" id="srcline592">592</a></span><span class="line"><span class="comment">% end end engine state</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,593" id="srcline593">593</a></span><span class="line"><span class="var type0" id="S130T0U1649">engEndEnd</span> = <span class="var type0" id="S122T0U1652">engStaVec_timInx</span>(<span class="var type0" id="S29T0U1653">timInxEnd</span>) - 1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,594" id="srcline594">594</a></span><span class="line"><span class="comment">% end gear condition</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,595" id="srcline595">595</a></span><span class="line"><span class="var type0" id="S131T0U1657">staEnd</span> = <span class="var type0" id="S30T0U1658">staBeg</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,596" id="srcline596">596</a></span><span class="line"><span class="comment">% end engine condition</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,597" id="srcline597">597</a></span><span class="line"><span class="var type0" id="S26T0U1661">engEnd</span> = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,598" id="srcline598">598</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,599" id="srcline599">599</a></span><span class="line"><span class="comment">% % selecting all end battery charge conditions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,600" id="srcline600">600</a></span><span class="line"><span class="var type0" id="S132T0U1665">batEngEndMinIdx</span>  = <span class="var type0" id="S65T0U1668">batEngEndMin</span> / <span class="var type0" id="S31T0U1669">batEngStp</span> + 1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,601" id="srcline601">601</a></span><span class="line"><span class="var type0" id="S133T0U1673">batEngEndMaxIdx</span>  = <span class="var type0" id="S66T0U1676">batEngEndMax</span> / <span class="var type0" id="S31T0U1677">batEngStp</span> + 1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,602" id="srcline602">602</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,603" id="srcline603">603</a></span><span class="line"><span class="var type0" id="S134T0U1681">batEndInxVec</span> = <span class="var type0" id="S132T0U1683">batEngEndMinIdx</span> : <span class="var type0" id="S133T0U1684">batEngEndMaxIdx</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,604" id="srcline604">604</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,605" id="srcline605">605</a></span><span class="line"><span class="comment">%% Calculating optimal trajectories for result of DP + PMP</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,606" id="srcline606">606</a></span><span class="line"><span class="comment">% preallocate matrices for holding all optimal combinations</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,607" id="srcline607">607</a></span><span class="line"><span class="var type0" id="S2T0U1687">batEngDltOptMat</span> = inf(<span class="var type0" id="S49T0U1690">timNum</span>, length(<span class="var type0" id="S134T0U1693">batEndInxVec</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,608" id="srcline608">608</a></span><span class="line"><span class="var type0" id="S3T0U1696">fulEngDltOptMat</span> = inf(<span class="var type0" id="S49T0U1699">timNum</span>, length(<span class="var type0" id="S134T0U1702">batEndInxVec</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,609" id="srcline609">609</a></span><span class="line"><span class="var type0" id="S4T0U1705">geaStaMat</span>       = inf(<span class="var type0" id="S49T0U1708">timNum</span>, length(<span class="var type0" id="S134T0U1711">batEndInxVec</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,610" id="srcline610">610</a></span><span class="line"><span class="var type0" id="S5T0U1714">engStaMat</span>       = inf(<span class="var type0" id="S49T0U1717">timNum</span>, length(<span class="var type0" id="S134T0U1720">batEndInxVec</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,611" id="srcline611">611</a></span><span class="line"><span class="var type0" id="S6T0U1723">batPwrMat</span>       = inf(<span class="var type0" id="S49T0U1726">timNum</span>, length(<span class="var type0" id="S134T0U1729">batEndInxVec</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,612" id="srcline612">612</a></span><span class="line"><span class="var type0" id="S7T0U1732">batEngMat</span>       = inf(<span class="var type0" id="S49T0U1735">timNum</span>, length(<span class="var type0" id="S134T0U1738">batEndInxVec</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,613" id="srcline613">613</a></span><span class="line"><span class="var type0" id="S8T0U1741">fulEngOptVec</span>    = inf(length(<span class="var type0" id="S134T0U1746">batEndInxVec</span>), 1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,614" id="srcline614">614</a></span><span class="line">fprintf(<span class="string">'Generating all optimal paths from ending SOC levels %2.0f%% to %2.0f%%\n'</span>, <span class="var type0" id="S22T0U1753">batEngEndMinRat</span>*100, <span class="var type0" id="S23T0U1756">batEngEndMaxRat</span>*100);</span></span>
<span class="srcline"><span class="lineno"><a href="1,615" id="srcline615">615</a></span><span class="line"><span class="keyword">for</span> <span class="var type0" id="S136T0U1760">batEndInx_counter</span> = 1 : length(<span class="var type0" id="S134T0U1765">batEndInxVec</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,616" id="srcline616">616</a></span><span class="line">    <span class="var type0" id="S137T0U1768">batEndInx</span> = <span class="var type0" id="S134T0U1770">batEndInxVec</span>(<span class="var type0" id="S136T0U1771">batEndInx_counter</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,617" id="srcline617">617</a></span><span class="line">[<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,618" id="srcline618">618</a></span><span class="line">    <span class="var type0" id="S2T0U1776">batEngDltOptMat</span>(:, <span class="var type0" id="S136T0U1778">batEndInx_counter</span>),  <span class="keyword">...</span><span class="comment"> Vektor - optimale Batterieenergieï¿½nderung</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,619" id="srcline619">619</a></span><span class="line">    <span class="var type0" id="S3T0U1780">fulEngDltOptMat</span>(:, <span class="var type0" id="S136T0U1782">batEndInx_counter</span>),  <span class="keyword">...</span><span class="comment"> Vektor - optimale Kraftstoffenergieï¿½nderung</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,620" id="srcline620">620</a></span><span class="line">    <span class="var type0" id="S4T0U1784">geaStaMat</span>(:, <span class="var type0" id="S136T0U1786">batEndInx_counter</span>),        <span class="keyword">...</span><span class="comment"> Vektor - Trajektorie des optimalen Antriebsstrangzustands</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,621" id="srcline621">621</a></span><span class="line">    <span class="var type0" id="S5T0U1788">engStaMat</span>(:, <span class="var type0" id="S136T0U1790">batEndInx_counter</span>),        <span class="keyword">...</span><span class="comment"> vector showing optimal engine contorl w/ profile</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,622" id="srcline622">622</a></span><span class="line">    <span class="var type0" id="S6T0U1792">batPwrMat</span>(:, <span class="var type0" id="S136T0U1794">batEndInx_counter</span>),        <span class="keyword">...</span><span class="comment"> vector showing optimal battery level control</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,623" id="srcline623">623</a></span><span class="line">    <span class="var type0" id="S7T0U1796">batEngMat</span>(:, <span class="var type0" id="S136T0U1798">batEndInx_counter</span>),        <span class="keyword">...</span><span class="comment"> vector showing optimal battery levels</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,624" id="srcline624">624</a></span><span class="line">    <span class="var type0" id="S8T0U1800">fulEngOptVec</span>(<span class="var type0" id="S136T0U1801">batEndInx_counter</span>)         <span class="keyword">...</span><span class="comment"> Skalar - optimale Kraftstoffenergie</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,625" id="srcline625">625</a></span><span class="line">    ] =             <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,626" id="srcline626">626</a></span><span class="line">    clcOptTrj_focus <span class="keyword">...</span><span class="comment"> FUNKTION</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,627" id="srcline627">627</a></span><span class="line">    (<span class="var type0" id="S15T0U1804">disFlg</span>,        <span class="keyword">...</span><span class="comment"> Flag, ob Zielzustand genutzt werden muss - CHANGE VAR NAME ITS THE SAME VAR FOR 2 DIFFERENT USES IN 2 FUNCTIONS</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,628" id="srcline628">628</a></span><span class="line">    <span class="var type0" id="S19T0U1805">timStp</span>,         <span class="keyword">...</span><span class="comment"> Skalar fï¿½r die Wegschrittweite in m</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,629" id="srcline629">629</a></span><span class="line">    <span class="var type0" id="S31T0U1806">batEngStp</span>,      <span class="keyword">...</span><span class="comment"> scalar - bat energy discretization step</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,630" id="srcline630">630</a></span><span class="line">    <span class="var type0" id="S49T0U1807">timNum</span>,         <span class="keyword">...</span><span class="comment"> Skalar fï¿½r die max. Anzahl an Wegstï¿½tzstellen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,631" id="srcline631">631</a></span><span class="line">    <span class="var type0" id="S28T0U1808">timInxBeg</span>,      <span class="keyword">...</span><span class="comment"> Skalar fï¿½r Anfangsindex in den Eingangsdaten</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,632" id="srcline632">632</a></span><span class="line">    <span class="var type0" id="S29T0U1809">timInxEnd</span>,      <span class="keyword">...</span><span class="comment"> Skalar fï¿½r Endindex in den Eingangsdaten</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,633" id="srcline633">633</a></span><span class="line">    <span class="var type0" id="S131T0U1810">staEnd</span>,         <span class="keyword">...</span><span class="comment"> Skalar fï¿½r den finalen Zustand</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,634" id="srcline634">634</a></span><span class="line">    <span class="var type0" id="S26T0U1811">engEnd</span>,         <span class="keyword">...</span><span class="comment"> scalar - final engine state</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,635" id="srcline635">635</a></span><span class="line">    <span class="var type0" id="S130T0U1812">engEndEnd</span>,      <span class="keyword">...</span><span class="comment"> Skalar fï¿½r Zielindex der kinetischen Energie</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,636" id="srcline636">636</a></span><span class="line">    <span class="var type0" id="S137T0U1813">batEndInx</span>,      <span class="keyword">...</span><span class="comment"> scalar - final battery state</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,637" id="srcline637">637</a></span><span class="line">    <span class="var type0" id="S34T0U1814">geaStaNum</span>,      <span class="keyword">...</span><span class="comment"> Skalar fï¿½r die max. Anzahl an Zustandsstï¿½tzstellen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,638" id="srcline638">638</a></span><span class="line">    <span class="var type0" id="S35T0U1815">engStaNum</span>,      <span class="keyword">...</span><span class="comment"> scalar - for number of states engine can take</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,639" id="srcline639">639</a></span><span class="line">    <span class="var type0" id="S36T0U1816">batStaNum</span>,      <span class="keyword">...</span><span class="comment"> scalar - for number of battery energy levels</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,640" id="srcline640">640</a></span><span class="line">    <span class="var type0" id="S125T0U1817">optPreInxTn4</span>,   <span class="keyword">...</span><span class="comment"> Tensor 3. Stufe fï¿½r opt. Vorgï¿½ngerkoordinaten</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,641" id="srcline641">641</a></span><span class="line">    <span class="var type0" id="S126T0U1818">batPwrOptTn4</span>,   <span class="keyword">...</span><span class="comment"> Tensor 3. Stufe der Batteriekraft</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,642" id="srcline642">642</a></span><span class="line">    <span class="var type0" id="S127T0U1819">fulEngOptTn4</span>,   <span class="keyword">...</span><span class="comment"> Tensor 3. Stufe fï¿½r die Kraftstoffenergie</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,643" id="srcline643">643</a></span><span class="line">    <span class="var type0" id="S128T0U1820">cos2goActTn3</span>    <span class="keyword">...</span><span class="comment"> Matrix der optimalen Kosten der Hamiltonfunktion </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,644" id="srcline644">644</a></span><span class="line">    );</span></span>
<span class="srcline"><span class="lineno"><a href="1,645" id="srcline645">645</a></span><span class="line">    <span class="keyword">if</span> <span class="var type0" id="S15T0U1823">disFlg</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,646" id="srcline646">646</a></span><span class="line">        fprintf(<span class="string">'Schleife %1.0f berechnet. %1.0f %% geschafft. \r'</span>, <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,647" id="srcline647">647</a></span><span class="line">            double(<span class="var type0" id="S136T0U1831">batEndInx_counter</span>-1), double(((<span class="var type0" id="S136T0U1840">batEndInx_counter</span>-1))) /<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,648" id="srcline648">648</a></span><span class="line">            double(length(<span class="var type0" id="S134T0U1847">batEndInxVec</span>)-1)*100);</span></span>
<span class="srcline"><span class="lineno"><a href="1,649" id="srcline649">649</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,650" id="srcline650">650</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,651" id="srcline651">651</a></span><span class="line"><span class="comment">% batEngDltOptVec=0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,652" id="srcline652">652</a></span><span class="line"><span class="comment">% fulEngDltOptVec=0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,653" id="srcline653">653</a></span><span class="line"><span class="comment">% fulEngOpt=0;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,654" id="srcline654">654</a></span><span class="line"><span class="var type0" id="S9T0U1852">resVld</span> = true;</span></span>
<span class="srcline"><span class="lineno"><a href="1,655" id="srcline655">655</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,656" id="srcline656">656</a></span><span class="line">fprintf(<span class="string">'\n\ndone!\n'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,657" id="srcline657">657</a></span><span class="line">   </span></span>
<span class="srcline"><span class="lineno"><a href="1,658" id="srcline658">658</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,659" id="srcline659">659</a></span><span class="line"><span class="comment">%% some plotting</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,660" id="srcline660">660</a></span><span class="line"><span class="comment">% batEng trajectories for all ending SOC possibilities (currently 30%-90%)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,661" id="srcline661">661</a></span><span class="line">figure(1)</span></span>
<span class="srcline"><span class="lineno"><a href="1,662" id="srcline662">662</a></span><span class="line"><span class="var type0" id="S142T0U1865">bluVal</span> = 1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,663" id="srcline663">663</a></span><span class="line"><span class="var type0" id="S143T0U1869">redVal</span> = 0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,664" id="srcline664">664</a></span><span class="line"><span class="var type0" id="S144T0U1873">batEngMatSOC</span> = <span class="var type0" id="S7T0U1875">batEngMat</span> / <span class="var type0" id="S32T0U1876">batEngMax</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,665" id="srcline665">665</a></span><span class="line">plot(<span class="var type0" id="S42T0U1880">timVec</span>, <span class="var type0" id="S144T0U1882">batEngMatSOC</span>(:, 1), <span class="string">'Color'</span>, [<span class="var type0" id="S143T0U1888">redVal</span> 0 <span class="var type0" id="S142T0U1890">bluVal</span>]); </span></span>
<span class="srcline"><span class="lineno"><a href="1,666" id="srcline666">666</a></span><span class="line">hold <span class="string">on</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,667" id="srcline667">667</a></span><span class="line"><span class="comment">% titleString = sprintf('batEng trajectories for all optimal paths from ending SOC levels %2.0f%% : %2.0f%%\n', batEngEndMinRat*100, batEngEndMaxRat*100);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,668" id="srcline668">668</a></span><span class="line"><span class="var type0" id="S147T0U1896">titleString</span> = <span class="string">'batEng trajectories for optimal paths'</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,669" id="srcline669">669</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,670" id="srcline670">670</a></span><span class="line">title(<span class="var type0" id="S147T0U1901">titleString</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,671" id="srcline671">671</a></span><span class="line">xlabel(<span class="string">'Time [sec]'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,672" id="srcline672">672</a></span><span class="line">ylabel(<span class="string">'SOC [%]'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,673" id="srcline673">673</a></span><span class="line"><span class="keyword">for</span> <span class="var type0" id="S136T0U1912">batEndInx_counter</span> = 2 : length(<span class="var type0" id="S134T0U1917">batEndInxVec</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,674" id="srcline674">674</a></span><span class="line">    <span class="var type0" id="S151T0U1920">scaVal</span> = double(((<span class="var type0" id="S136T0U1927">batEndInx_counter</span>-1))) / double(length(<span class="var type0" id="S134T0U1934">batEndInxVec</span>)-1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,675" id="srcline675">675</a></span><span class="line">    plot(<span class="var type0" id="S42T0U1939">timVec</span>, <span class="var type0" id="S144T0U1941">batEngMatSOC</span>(:, <span class="var type0" id="S136T0U1943">batEndInx_counter</span>), <span class="string">'Color'</span>, [<span class="var type0" id="S143T0U1948">redVal</span>+<span class="var type0" id="S151T0U1949">scaVal</span> 0 <span class="var type0" id="S142T0U1952">bluVal</span>-<span class="var type0" id="S151T0U1953">scaVal</span>]); </span></span>
<span class="srcline"><span class="lineno"><a href="1,676" id="srcline676">676</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,677" id="srcline677">677</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,678" id="srcline678">678</a></span><span class="line"><span class="comment">% fuel trajectories for all ending SOC possibilities (currently 30%-90%)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,679" id="srcline679">679</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,680" id="srcline680">680</a></span><span class="line">figure(2)</span></span>
<span class="srcline"><span class="lineno"><a href="1,681" id="srcline681">681</a></span><span class="line">plot(<span class="var type0" id="S42T0U1962">timVec</span>(1:end-1), <span class="var type0" id="S3T0U1970">fulEngDltOptMat</span>(1:end-1, 1), <span class="string">'Color'</span>, [<span class="var type0" id="S143T0U1981">redVal</span> 0 <span class="var type0" id="S142T0U1983">bluVal</span>]); </span></span>
<span class="srcline"><span class="lineno"><a href="1,682" id="srcline682">682</a></span><span class="line">hold <span class="string">on</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,683" id="srcline683">683</a></span><span class="line"><span class="var type0" id="S147T0U1989">titleString</span> = <span class="string">'fuel trajectories for optimal paths'</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,684" id="srcline684">684</a></span><span class="line">title(<span class="var type0" id="S147T0U1994">titleString</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,685" id="srcline685">685</a></span><span class="line">xlabel(<span class="string">'Time [sec]'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,686" id="srcline686">686</a></span><span class="line">ylabel(<span class="string">'Fuel Use [J]'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,687" id="srcline687">687</a></span><span class="line"><span class="keyword">for</span> <span class="var type0" id="S152T0U2005">fulEngInx_counter</span> = 2 : length(<span class="var type0" id="S134T0U2010">batEndInxVec</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,688" id="srcline688">688</a></span><span class="line">    <span class="var type0" id="S151T0U2013">scaVal</span> = double(((<span class="var type0" id="S152T0U2020">fulEngInx_counter</span>-1))) / double(length(<span class="var type0" id="S134T0U2027">batEndInxVec</span>)-1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,689" id="srcline689">689</a></span><span class="line">    plot(<span class="var type0" id="S42T0U2033">timVec</span>(1:end-1), <span class="var type0" id="S3T0U2041">fulEngDltOptMat</span>(1:end-1, <span class="var type0" id="S152T0U2048">fulEngInx_counter</span>), <span class="string">'Color'</span>, [<span class="var type0" id="S143T0U2053">redVal</span>+<span class="var type0" id="S151T0U2054">scaVal</span> 0 <span class="var type0" id="S142T0U2057">bluVal</span>-<span class="var type0" id="S151T0U2058">scaVal</span>]); </span></span>
<span class="srcline"><span class="lineno"><a href="1,690" id="srcline690">690</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,691" id="srcline691">691</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
